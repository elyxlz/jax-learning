

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  
<!-- Mirrored from orbax.readthedocs.io/en/latest/_modules/orbax/checkpoint/checkpoint_manager.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Jul 2024 12:12:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>orbax.checkpoint.checkpoint_manager &#8212; Orbax  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/themee6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrape6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-themee6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.mine6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/katex-math.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" />
    <link rel="stylesheet" type="text/css" href="https://orbax.readthedocs.io/_/static/css/badge_only.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrape6c2.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-themee6c2.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.mine6c2.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js"></script>
    <script src="../../../_static/katex.min.js"></script>
    <script src="../../../_static/auto-render.min.js"></script>
    <script src="../../../_static/katex_autorenderer.js"></script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://orbax.readthedocs.io/_/static/javascript/readthedocs-doc-embed.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/orbax/checkpoint/checkpoint_manager';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="https://orbax.readthedocs.io/_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/docs/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "_modules/orbax/checkpoint/checkpoint_manager", "programming_language": "py", "project": "orbax", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "latest"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="https://orbax.readthedocs.io/_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="https://orbax.readthedocs.io/en/latest/search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index-2.html">
  
  
  
  
  
  
    <p class="title logo__title">Orbax  documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Checkpointing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_checkpoint_announcements.html">Announcements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_checkpoint_101.html">Checkpointing with Orbax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_checkpoint_api_overview.html">API Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_refactor.html">Using the Refactored CheckpointManager API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpointing_pytrees.html">Checkpointing PyTrees of Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint_format.html">Checkpoint Format Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimized_checkpointing.html">Optimized Checkpointing with Tensorstore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_handlers.html">Customizing Checkpointing Logic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transformations.html">Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../preemption_checkpointing.html">Preemption Tolerance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../async_checkpointing.html">Asynchronous Checkpointing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api_reference/checkpoint.html">orbax.checkpoint API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.abstract_checkpoint_manager.html">AbstractCheckpointManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpoint_manager.html">CheckpointManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpointers.html">Checkpointers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpoint_handlers.html">CheckpointHandlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.args.html">CheckpointArgs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.type_handlers.html">TypeHandlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.path.atomicity.html">Atomicity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.path.step.html">Step entities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.path.deleter.html">Checkpoint Deleter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpoint_utils.html">Checkpointing Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.utils.html">General Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.transform_utils.html">PyTree Transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.msgpack_utils.html">Msgpack utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.multihost.html">Multi-host Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.tree.html">Tree Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.metadata.html">Metadata Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.logging.html">Checkpoint logging</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Exporting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_export_101.html">Exporting with Orbax</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api_reference/export.html">orbax.export API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.dtensor_utils.html">DTensor utilities for multi-device/host export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.export_manager.html">ExportManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.export_manager_base.html">ExportManagerBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.jax_module.html">JaxModule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.serving_config.html">ServingConfig</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.utils.html">General Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.validate.validation_manager.html">ValidationManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.validate.validation_report.html">ValidationReport</a></li>

</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Information</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">

  <div id="ethical-ad-placement"
       class="flat"
       data-ea-publisher="readthedocs"
       data-ea-type="readthedocs-sidebar"
       data-ea-manual="true">
  </div>
</div>
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for orbax.checkpoint.checkpoint_manager</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2024 The Orbax Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;A class providing functionalities for managing a series of checkpoints.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Container</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">etils</span> <span class="kn">import</span> <span class="n">epath</span>
<span class="kn">from</span> <span class="nn">etils</span> <span class="kn">import</span> <span class="n">epy</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">from</span> <span class="nn">jax.experimental.array_serialization</span> <span class="kn">import</span> <span class="n">serialization</span> <span class="k">as</span> <span class="n">jax_serialization</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">abstract_checkpoint_manager</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">abstract_checkpointer</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">args</span> <span class="k">as</span> <span class="n">args_lib</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">async_checkpointer</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint_args</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint_handler</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">checkpointer</span> <span class="k">as</span> <span class="n">checkpointer_lib</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">composite_checkpoint_handler</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">json_checkpoint_handler</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">multihost</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">options</span> <span class="k">as</span> <span class="n">options_lib</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">proto_checkpoint_handler</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.logging</span> <span class="kn">import</span> <span class="n">abstract_logger</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.logging</span> <span class="kn">import</span> <span class="n">standard_logger</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.logging</span> <span class="kn">import</span> <span class="n">step_statistics</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.metadata</span> <span class="kn">import</span> <span class="n">checkpoint</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.path</span> <span class="kn">import</span> <span class="n">atomicity</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.path</span> <span class="kn">import</span> <span class="n">deleter</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.path</span> <span class="kn">import</span> <span class="n">step</span> <span class="k">as</span> <span class="n">step_lib</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Self</span>  <span class="c1"># for Python version &lt; 3.11</span>


<span class="n">PyTree</span> <span class="o">=</span> <span class="n">Any</span>
<span class="n">CheckpointDirs</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">SaveParams</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="n">RestoreParams</span> <span class="o">=</span> <span class="n">SaveParams</span>
<span class="n">AbstractCheckpointer</span> <span class="o">=</span> <span class="n">abstract_checkpointer</span><span class="o">.</span><span class="n">AbstractCheckpointer</span>
<span class="n">CheckpointersDict</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AbstractCheckpointer</span><span class="p">]</span>
<span class="n">AbstractCheckpointManager</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">abstract_checkpoint_manager</span><span class="o">.</span><span class="n">AbstractCheckpointManager</span>
<span class="p">)</span>
<span class="n">AsyncCheckpointer</span> <span class="o">=</span> <span class="n">async_checkpointer</span><span class="o">.</span><span class="n">AsyncCheckpointer</span>
<span class="n">Checkpointer</span> <span class="o">=</span> <span class="n">checkpointer_lib</span><span class="o">.</span><span class="n">Checkpointer</span>
<span class="n">JsonCheckpointHandler</span> <span class="o">=</span> <span class="n">json_checkpoint_handler</span><span class="o">.</span><span class="n">JsonCheckpointHandler</span>
<span class="n">ProtoCheckpointHandler</span> <span class="o">=</span> <span class="n">proto_checkpoint_handler</span><span class="o">.</span><span class="n">ProtoCheckpointHandler</span>
<span class="n">CompositeCheckpointHandler</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">composite_checkpoint_handler</span><span class="o">.</span><span class="n">CompositeCheckpointHandler</span>
<span class="p">)</span>
<span class="n">CheckpointHandler</span> <span class="o">=</span> <span class="n">checkpoint_handler</span><span class="o">.</span><span class="n">CheckpointHandler</span>
<span class="n">CheckpointArgs</span> <span class="o">=</span> <span class="n">checkpoint_args</span><span class="o">.</span><span class="n">CheckpointArgs</span>
<span class="n">CheckpointHandlersDict</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CheckpointHandler</span><span class="p">]</span>

<span class="n">AsyncOptions</span> <span class="o">=</span> <span class="n">options_lib</span><span class="o">.</span><span class="n">AsyncOptions</span>
<span class="n">MultiprocessingOptions</span> <span class="o">=</span> <span class="n">options_lib</span><span class="o">.</span><span class="n">MultiprocessingOptions</span>
<span class="n">FileOptions</span> <span class="o">=</span> <span class="n">options_lib</span><span class="o">.</span><span class="n">FileOptions</span>

<span class="n">DEFAULT_ITEM_NAME</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
<span class="n">DESCRIPTOR_ITEM_NAME</span> <span class="o">=</span> <span class="s1">&#39;descriptor&#39;</span>
<span class="n">METRIC_ITEM_NAME</span> <span class="o">=</span> <span class="s1">&#39;metrics&#39;</span>
<span class="n">METADATA_ITEM_NAME</span> <span class="o">=</span> <span class="s1">&#39;metadata&#39;</span>
<span class="n">RESERVED_ITEM_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="n">DESCRIPTOR_ITEM_NAME</span><span class="p">,</span> <span class="n">METRIC_ITEM_NAME</span><span class="p">]</span>

<span class="n">_INIT_TIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_metrics_file_exists</span><span class="p">(</span><span class="n">metrics_item_path</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;True if item directory AND actual file both exist.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">(</span>
      <span class="n">metrics_item_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
      <span class="ow">and</span> <span class="p">(</span><span class="n">metrics_item_path</span> <span class="o">/</span> <span class="n">METRIC_ITEM_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
  <span class="p">)</span>


<span class="k">def</span> <span class="nf">_descriptor_file_exists</span><span class="p">(</span><span class="n">descriptor_item_path</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;True if item directory AND actual file both exist.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">(</span>
      <span class="n">descriptor_item_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
      <span class="ow">and</span> <span class="p">(</span><span class="n">descriptor_item_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DESCRIPTOR_ITEM_NAME</span><span class="si">}</span><span class="s1">.pbtxt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
  <span class="p">)</span>


<span class="k">class</span> <span class="nc">StepAlreadyExistsError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Raised when a step is already present for a save request.&quot;&quot;&quot;</span>

  <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_FinalizeThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Thread wrapper that raises an exception if encountered.&quot;&quot;&quot;</span>

  <span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint:disable=broad-exception-caught</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>

  <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
      <span class="n">exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">raise</span> <span class="n">exception</span>


<span class="c1"># TODO(b/268051457) Clean up when no longer depended upon by internal users.</span>
<div class="viewcode-block" id="is_async_checkpointer"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.is_async_checkpointer">[docs]</a><span class="k">def</span> <span class="nf">is_async_checkpointer</span><span class="p">(</span><span class="n">checkpointer</span><span class="p">:</span> <span class="n">AbstractCheckpointer</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span>
      <span class="n">checkpointer</span><span class="p">,</span> <span class="n">async_checkpointer</span><span class="o">.</span><span class="n">AsyncCheckpointer</span>
  <span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
      <span class="n">checkpointer</span><span class="p">,</span>
      <span class="n">jax_serialization</span><span class="o">.</span><span class="n">GlobalAsyncCheckpointManagerBase</span><span class="p">,</span>
  <span class="p">)</span></div>


<span class="c1"># TODO(b/309965339) Set todelete_subdir defaults if directory is on CNS.</span>
<div class="viewcode-block" id="CheckpointManagerOptions"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManagerOptions">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">CheckpointManagerOptions</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Optional arguments for CheckpointManager.</span>

<span class="sd">  save_interval_steps:</span>
<span class="sd">    The interval at which checkpoints should be saved.</span>
<span class="sd">    Ensures checkpoints will only be saved every n steps. Defaults to 1.</span>
<span class="sd">  max_to_keep:</span>
<span class="sd">    If provided, specifies the maximum number of checkpoints to</span>
<span class="sd">    keep. Older checkpoints are removed. By default, does not remove any old</span>
<span class="sd">    checkpoints. Must be None or non-negative. When set, checkpoints</span>
<span class="sd">    may be considered for deletion when there are more than `max_to_keep`</span>
<span class="sd">    checkpoints present. Checkpoints are kept if they meet any of the conditions</span>
<span class="sd">    below, such as `keep_time_interval`, `keep_period`, etc. Any remaining</span>
<span class="sd">    checkpoints that do not meet these conditions are garbage-collected.</span>
<span class="sd">  keep_time_interval:</span>
<span class="sd">    When more than max_to_keep checkpoints are present,</span>
<span class="sd">    an older checkpoint that would ordinarily be deleted will be preserved if it</span>
<span class="sd">    has been at least `keep_time_interval` since the previous preserved</span>
<span class="sd">    checkpoint. The default setting of `None` does not preserve any checkpoints</span>
<span class="sd">    in this way. For example, this may be used to ensure checkpoints are</span>
<span class="sd">    retained at a frequency of approximately than one per hour.</span>
<span class="sd">  keep_period:</span>
<span class="sd">    If set, any existing checkpoints matching checkpoint_step % keep_period == 0</span>
<span class="sd">    will not be deleted.</span>
<span class="sd">  best_fn:</span>
<span class="sd">    If set, maintains checkpoints based on the quality of given</span>
<span class="sd">    metrics rather than recency. The function should accept a PyTree of metrics,</span>
<span class="sd">    and return a scalar value that can be used to determine the quality score</span>
<span class="sd">    of the checkpoint. If `max_to_keep` is also set, then the retained</span>
<span class="sd">    checkpoints will be kept based on their quality, as measured by this</span>
<span class="sd">    function.</span>
<span class="sd">  best_mode:</span>
<span class="sd">    One of [&#39;max&#39;, &#39;min&#39;]. The best metric is determine on the basis of this</span>
<span class="sd">    value.</span>
<span class="sd">  keep_checkpoints_without_metrics:</span>
<span class="sd">    If False, checkpoints without metrics present</span>
<span class="sd">    are eligible for cleanup. Otherwise, they will never be deleted.</span>
<span class="sd">  step_prefix:</span>
<span class="sd">    If provided, step directories will take the form</span>
<span class="sd">    f&#39;{step_prefix}_&lt;step&gt;&#39;. Otherwise, they will simply be an integer &lt;step&gt;.</span>
<span class="sd">  step_format_fixed_length:</span>
<span class="sd">    If set, formats step with n digits (leading zeros).</span>
<span class="sd">    This makes sorting steps easier. Otherwise, step has no leading zeros.</span>
<span class="sd">  step_name_format:</span>
<span class="sd">    NameFormat to build or find steps under input root directory. If provided,</span>
<span class="sd">    `step_prefix`, `step_format_fixed_length` are ignored.</span>
<span class="sd">  create:</span>
<span class="sd">    If True, creates the top-level directory if it does not already exist.</span>
<span class="sd">  cleanup_tmp_directories:</span>
<span class="sd">    If True, cleans up any existing temporary directories</span>
<span class="sd">    on CheckpointManager creation.</span>
<span class="sd">  save_on_steps:</span>
<span class="sd">    Optional set of steps at which checkpoints should be saved.</span>
<span class="sd">    Useful to save checkpoints on a fixed set of steps that are not multiple of</span>
<span class="sd">    `save_interval_steps`.</span>
<span class="sd">  single_host_load_and_broadcast:</span>
<span class="sd">    If True, calling `all_steps(read=True)` will load on only a single host, and</span>
<span class="sd">    will then be broadcast to other hosts. Otherwise, I/O will be performed on</span>
<span class="sd">    every host. This can be helpful to reduce QPS to the filesystem if there</span>
<span class="sd">    are a large number of hosts.</span>
<span class="sd">  todelete_subdir: If set, checkpoints to be deleted will be only renamed into a</span>
<span class="sd">    subdirectory with the provided string. Otherwise, they will be directly</span>
<span class="sd">    deleted from the file system. Useful if checkpoint deletion is time</span>
<span class="sd">    consuming. By default, delete the checkpoint assets. Ignored if file system</span>
<span class="sd">    is Google Cloud Storage (directory is prefixed with gs://)</span>
<span class="sd">  enable_background_delete: If True, old checkpoint deletions will be done in a</span>
<span class="sd">    background thread, otherwise, it will be done at the end of each save.  When</span>
<span class="sd">    it&#39;s enabled, make sure to call CheckpointManager.close() or use context to</span>
<span class="sd">    make sure all old steps are deleted before exit.</span>
<span class="sd">  read_only: If True, then checkpoints save and delete are skipped. However,</span>
<span class="sd">    checkpoints restore works as usual.</span>
<span class="sd">  enable_async_checkpointing:</span>
<span class="sd">    If True, enables async checkpointing.</span>
<span class="sd">  async_options:</span>
<span class="sd">    Used to configure properties of async behavior. See above.</span>
<span class="sd">  multiprocessing_options: MultiprocessingOptions instance to configure</span>
<span class="sd">    multiprocessing behavior.</span>
<span class="sd">  should_save_fn:</span>
<span class="sd">    Predicate callable to check if given step can be saved. This callable</span>
<span class="sd">    accepts step number and optional latest step number as param and returns</span>
<span class="sd">    bool. If present then `save_interval_steps` and `save_on_steps` options are</span>
<span class="sd">    ignored.</span>
<span class="sd">  file_options: Options to configure checkpoint directories and files.</span>
<span class="sd">    default=FileOptions().</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">save_interval_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">max_to_keep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">keep_time_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">keep_period</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">best_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">PyTree</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">best_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
  <span class="n">keep_checkpoints_without_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="n">step_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">step_format_fixed_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">step_name_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">step_lib</span><span class="o">.</span><span class="n">NameFormat</span><span class="p">[</span><span class="n">step_lib</span><span class="o">.</span><span class="n">Metadata</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="n">cleanup_tmp_directories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">save_on_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Container</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">single_host_load_and_broadcast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">todelete_subdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">enable_background_delete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">enable_async_checkpointing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="n">async_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">multiprocessing_options</span><span class="p">:</span> <span class="n">MultiprocessingOptions</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
      <span class="n">default_factory</span><span class="o">=</span><span class="n">MultiprocessingOptions</span>
  <span class="p">)</span>
  <span class="n">should_save_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">file_options</span><span class="p">:</span> <span class="n">FileOptions</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">FileOptions</span><span class="p">)</span>
  <span class="n">temporary_path_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">atomicity</span><span class="o">.</span><span class="n">TemporaryPath</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">):</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
          <span class="s2">&quot;`CheckpointManagerOptions.best_mode` must be one of None, &#39;min&#39; &quot;</span>
          <span class="s2">&quot;or &#39;max&#39;. Got </span><span class="si">{self.dtype}</span><span class="s2">.&quot;</span>
      <span class="p">)</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_to_keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_to_keep</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Setting of `max_to_keep` must be None or non-negative.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_interval_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_interval_steps</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting&#39;</span>
          <span class="s1">&#39; save_interval_steps=0.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_to_keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">max_to_keep</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting max_to_keep=None.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_time_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">keep_time_interval</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting&#39;</span>
          <span class="s1">&#39; keep_time_interval=None.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">keep_period</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting keep_period=None.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting create=False.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_tmp_directories</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_tmp_directories</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting&#39;</span>
          <span class="s1">&#39; cleanup_tmp_directories=False.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_on_steps</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_on_steps</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting save_on_steps=None.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">todelete_subdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">todelete_subdir</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting&#39;</span>
          <span class="s1">&#39; todelete_subdir=None.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_save_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">should_save_fn</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.read_only=True, setting&#39;</span>
          <span class="s1">&#39; should_save_fn=None.&#39;</span>
      <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_on_steps</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_on_steps</span> <span class="ow">or</span> <span class="p">())</span></div>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">CheckpointInfo</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Metadata about a checkpoint.&quot;&quot;&quot;</span>

  <span class="n">step</span><span class="p">:</span> <span class="nb">int</span>
  <span class="n">time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
  <span class="n">metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PyTree</span><span class="p">]</span>
  <span class="n">is_locked</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Users may provide step as a jax.Array.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;Checkpoint[step=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s1"> | time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s1"> |&#39;</span>
        <span class="sa">f</span><span class="s1">&#39; is_locked=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">is_locked</span><span class="si">}</span><span class="s1">]&#39;</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;CheckpointInfo&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">step</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">time</span>

  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_args_for_key</span><span class="p">(</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">CheckpointHandler</span><span class="p">,</span> <span class="n">item_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">CheckpointArgs</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="n">CheckpointArgs</span><span class="p">]]:</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">CompositeCheckpointHandler</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s1">&#39;Expected handler to be a `CompositeCheckpointHandler`, but got&#39;</span>
        <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">_known_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># pylint: disable=protected-access</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">item_name</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">checkpoint_args</span><span class="o">.</span><span class="n">get_registered_args_cls</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
  <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown key &quot;</span><span class="si">{</span><span class="n">item_name</span><span class="si">}</span><span class="s1">&quot; in CompositeCheckpointHandler.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_root_directory</span><span class="p">(</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">multiprocessing_options</span><span class="p">:</span> <span class="n">MultiprocessingOptions</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Creates the top-level directory if it does not already exist.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s1">&#39;Option `create=True` with `active_processes` set is not&#39;</span>
        <span class="s1">&#39; supported. Please create the root directory yourself.&#39;</span>
    <span class="p">)</span>
  <span class="n">directory</span> <span class="o">=</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_primary_host</span><span class="p">(</span>
      <span class="n">multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span>
  <span class="p">):</span>
    <span class="n">directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created directory=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
  <span class="n">multihost</span><span class="o">.</span><span class="n">sync_global_processes</span><span class="p">(</span>
      <span class="n">multihost</span><span class="o">.</span><span class="n">unique_barrier_key</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManager:create_directory&#39;</span><span class="p">,</span>
          <span class="n">prefix</span><span class="o">=</span><span class="n">multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
          <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="p">),</span>
      <span class="n">timeout</span><span class="o">=</span><span class="n">multihost</span><span class="o">.</span><span class="n">DIRECTORY_CREATION_TIMEOUT</span><span class="p">,</span>
      <span class="n">processes</span><span class="o">=</span><span class="n">multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
  <span class="p">)</span>


<div class="viewcode-block" id="CheckpointManager"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager">[docs]</a><span class="k">class</span> <span class="nc">CheckpointManager</span><span class="p">(</span><span class="n">AbstractCheckpointManager</span><span class="p">,</span> <span class="n">epy</span><span class="o">.</span><span class="n">ContextManager</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A generic, synchronous AbstractCheckpointManager implementation.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CheckpointManager.__init__"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">directory</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
      <span class="n">checkpointers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
          <span class="n">Union</span><span class="p">[</span><span class="n">AbstractCheckpointer</span><span class="p">,</span> <span class="n">CheckpointersDict</span><span class="p">]</span>
      <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CheckpointManagerOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">item_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">item_handlers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
          <span class="n">Union</span><span class="p">[</span><span class="n">CheckpointHandler</span><span class="p">,</span> <span class="n">CheckpointHandlersDict</span><span class="p">]</span>
      <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">abstract_logger</span><span class="o">.</span><span class="n">AbstractLogger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CheckpointManager constructor.</span>

<span class="sd">    IMPORTANT: `CheckpointManager` has been refactored to provide a new API.</span>
<span class="sd">    Please ensure you have migrated all existing use cases to the newer style by</span>
<span class="sd">    August 1st, 2024. Please see</span>
<span class="sd">    https://orbax.readthedocs.io/en/latest/api_refactor.html</span>
<span class="sd">    for technical details.</span>

<span class="sd">    The `CheckpointManager` is ultimately backed by a single `Checkpointer`, to</span>
<span class="sd">    which saving and restoring is delegated. Behind step management options,</span>
<span class="sd">    metrics-related logic, and other frills, saving and restoring with</span>
<span class="sd">    `CheckpointManager` is quite similar to using</span>
<span class="sd">    `Checkpointer(CompositeCheckpointHandler)`.</span>

<span class="sd">    Example::</span>

<span class="sd">      with CheckpointManager(</span>
<span class="sd">        &#39;path/to/dir/&#39;,</span>
<span class="sd">        # Multiple items.</span>
<span class="sd">        item_names=(&#39;train_state&#39;, &#39;custom_metadata&#39;),</span>
<span class="sd">        metadata={&#39;version&#39;: 1.1, &#39;lang&#39;: &#39;en&#39;},</span>
<span class="sd">      ) as mngr:</span>
<span class="sd">        mngr.save(0, args=args.Composite(</span>
<span class="sd">            train_state=args.StandardSave(train_state),</span>
<span class="sd">            custom_metadata=args.JsonSave(custom_metadata),</span>
<span class="sd">          )</span>
<span class="sd">        )</span>
<span class="sd">        restored = mngr.restore(0)</span>
<span class="sd">        print(restored.train_state)</span>
<span class="sd">        print(restored.custom_metadata)</span>
<span class="sd">        restored = mngr.restore(0, args=args.Composite(</span>
<span class="sd">            train_state=args.StandardRestore(abstract_train_state),</span>
<span class="sd">          )</span>
<span class="sd">        )</span>
<span class="sd">        print(restored.train_state)</span>
<span class="sd">        print(restored.custom_metadata)  # Error, not restored</span>

<span class="sd">      # Single item, no need to specify `item_names`.</span>
<span class="sd">      with CheckpointManager(</span>
<span class="sd">          &#39;path/to/dir/&#39;,</span>
<span class="sd">          options = CheckpointManagerOptions(max_to_keep=5, ...),</span>
<span class="sd">        ) as mngr:</span>
<span class="sd">        mngr.save(0, args=StandardSave(train_state))</span>
<span class="sd">        train_state = mngr.restore(0)</span>
<span class="sd">        train_state = mngr.restore(0,</span>
<span class="sd">        args=StandardRestore(abstract_train_state))</span>

<span class="sd">    IMPORTANT: Don&#39;t forget to use the keyword `args=...` for save and restore!</span>
<span class="sd">    Otherwise you will get the legacy API. This will not be necessary forever,</span>
<span class="sd">    but only until the legacy API is removed.</span>

<span class="sd">    IMPORTANT: The CheckpointManager is designed to be used as a context</span>
<span class="sd">    manager. Use `with CheckpointManager` schematic for automatic cleanup. If</span>
<span class="sd">    you can&#39;t use a context manager, always call `close()` to release resources</span>
<span class="sd">    properly.  Otherwise, background operations such as deleting old checkpoints</span>
<span class="sd">    might not finish before your program exits.</span>

<span class="sd">    CheckpointManager:</span>
<span class="sd">      - is NOT thread-safe.</span>
<span class="sd">      - IS multi-process-safe.</span>
<span class="sd">      - is NOT multi-job-safe.</span>
<span class="sd">    This means that CheckpointManager is intended to be created and called</span>
<span class="sd">    across all processes within a single job, where each process is</span>
<span class="sd">    single-threaded, but is not safe to use when multiple jobs each have</span>
<span class="sd">    CheckpointManager instances pointing to the same root directory. Concretely,</span>
<span class="sd">    this means that if you have a trainer job and one or more evaluator jobs,</span>
<span class="sd">    the CheckpointManager should be created and called across all processes</span>
<span class="sd">    in the trainer, but a CheckpointManager cannot be used in the evaluators.</span>
<span class="sd">    Instead, utilities used during evaluation can be found in</span>
<span class="sd">    `checkpoint_utils` (see</span>
<span class="sd">    https://orbax.readthedocs.io/en/latest/api_reference/checkpoint.checkpoint_utils.html).</span>

<span class="sd">    Args:</span>
<span class="sd">      directory: the top level directory in which to save all files.</span>
<span class="sd">      checkpointers: a mapping of object name to Checkpointer object. For</span>
<span class="sd">        example, `items` provided to `save` below should have keys matching the</span>
<span class="sd">        keys in this argument. Alternatively, a single Checkpointer may be</span>
<span class="sd">        provided, in which case `save` and `restore` should always be called</span>
<span class="sd">        with a single item rather than a dictionary of items. See below for more</span>
<span class="sd">        details. `item_names` and `checkpointers` are mutually exclusive - do</span>
<span class="sd">        not use together. Also, please don&#39;t use `checkpointers` and</span>
<span class="sd">        `item_handlers` together.</span>
<span class="sd">      options: CheckpointManagerOptions. May be provided to specify additional</span>
<span class="sd">        arguments. If None, uses default values of CheckpointManagerOptions.</span>
<span class="sd">      metadata: High-level metadata that does not depend on step number. If</span>
<span class="sd">        `directory` is write enabled then given metadata is saved only once. A</span>
<span class="sd">        new CheckpointManager instance with that `directory` does not overwrite</span>
<span class="sd">        the existing metadata and ignores the current given metadata. If</span>
<span class="sd">        `directory` is read-only then the current given metadata is not saved as</span>
<span class="sd">        expected. A CheckpointManager instance with a read-only `directory` uses</span>
<span class="sd">        the metadata if already present, otherwise always uses the current given</span>
<span class="sd">        metadata.</span>
<span class="sd">      item_names: Names of distinct items that may be saved/restored with this</span>
<span class="sd">        `CheckpointManager`. `item_names` and `checkpointers` are mutually</span>
<span class="sd">        exclusive - do not use together. Also see `item_handlers` below.</span>
<span class="sd">      item_handlers: A mapping of item name to `CheckpointHandler`. The mapped</span>
<span class="sd">        CheckpointHandler must be registered against the `CheckpointArgs` input</span>
<span class="sd">        in save/restore operations. Please don&#39;t use `checkpointers` and</span>
<span class="sd">        `item_handlers` together. It can be used with or without `item_names`.</span>
<span class="sd">        The item name key may or may not be present in `item_names`.</span>
<span class="sd">        Alternatively, a single CheckpointHandler may be provided, in which case</span>
<span class="sd">        `save` and `restore` should always be called in a single item context.</span>
<span class="sd">      logger: A logger to log checkpointing events.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event</span><span class="p">(</span><span class="s1">&#39;/jax/orbax/checkpoint_manager/init&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="n">CheckpointManagerOptions</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">best_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`best_mode` must be one of: &quot;min&quot;, &quot;max&quot;&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">multiprocessing_options</span> <span class="ow">or</span> <span class="n">MultiprocessingOptions</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">standard_logger</span><span class="o">.</span><span class="n">StandardLogger</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">checkpointers</span> <span class="ow">and</span> <span class="n">item_names</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;`item_names` and `checkpointers` are mutually exclusive - do not use&#39;</span>
          <span class="s1">&#39; together.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="n">checkpointers</span> <span class="ow">and</span> <span class="n">item_handlers</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;`item_handlers` and `checkpointers` are mutually exclusive - do not&#39;</span>
          <span class="s1">&#39; use together.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="n">item_names</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_handlers</span><span class="p">,</span> <span class="n">CheckpointHandler</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;`item_handlers` in single item mode and `item_names` should not be&#39;</span>
          <span class="s1">&#39; provided together.&#39;</span>
      <span class="p">)</span>
    <span class="c1"># For async_checkpointer.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_non_blocking_checkpoint_metadata_store</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">checkpoint</span><span class="o">.</span><span class="n">checkpoint_metadata_store</span><span class="p">(</span><span class="n">enable_write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># For metadata checkpointer and regular checkpointer.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_checkpoint_metadata_store</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">checkpoint</span><span class="o">.</span><span class="n">checkpoint_metadata_store</span><span class="p">(</span>
            <span class="n">enable_write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blocking_write</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">checkpointers</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;Configured `CheckpointManager` using deprecated legacy API. Please&#39;</span>
          <span class="s1">&#39; follow the instructions at&#39;</span>
          <span class="s1">&#39; https://orbax.readthedocs.io/en/latest/api_refactor.html to&#39;</span>
          <span class="s1">&#39; migrate by August 1st, 2024.&#39;</span>
      <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpointers</span><span class="p">,</span> <span class="n">AbstractCheckpointer</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure_checkpointer_legacy_init</span><span class="p">(</span>
          <span class="n">checkpointers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span>
      <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_handlers</span><span class="p">,</span> <span class="n">CheckpointHandler</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
          <span class="n">item_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item_handlers</span> <span class="ow">is</span> <span class="kc">None</span>
      <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure_checkpointer</span><span class="p">(</span>
          <span class="n">item_names</span><span class="p">,</span> <span class="n">item_handlers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span>
      <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span> <span class="o">=</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Given directory is read only=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
      <span class="n">_create_root_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="p">)</span>


    <span class="c1"># Cleanup directories from previous runs that may not have been finalized.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">cleanup_tmp_directories</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_tmp_directories</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_step_name_format</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">step_name_format</span>
        <span class="ow">or</span> <span class="n">step_lib</span><span class="o">.</span><span class="n">standard_name_format</span><span class="p">(</span>
            <span class="n">step_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">step_prefix</span><span class="p">,</span>
            <span class="n">step_format_fixed_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">step_format_fixed_length</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_checkpoint_infos</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_checkpointer</span> <span class="o">=</span> <span class="n">Checkpointer</span><span class="p">(</span>
        <span class="n">JsonCheckpointHandler</span><span class="p">(</span>
            <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span>
        <span class="p">),</span>
        <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
        <span class="n">active_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
        <span class="n">barrier_sync_key_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
        <span class="n">path_permission_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">file_options</span><span class="o">.</span><span class="n">path_permission_mode</span><span class="p">,</span>
        <span class="n">checkpoint_metadata_store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocking_checkpoint_metadata_store</span><span class="p">,</span>
        <span class="n">temporary_path_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">temporary_path_class</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_path</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">metadata</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_save_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_thread</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_deleter</span><span class="p">:</span> <span class="n">deleter</span><span class="o">.</span><span class="n">CheckpointDeleter</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">deleter</span><span class="o">.</span><span class="n">create_checkpoint_deleter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">todelete_subdir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_name_format</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">enable_background_delete</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;CheckpointManager created, jax.process_index=</span><span class="si">%s</span><span class="s1">, primary_host=</span><span class="si">%s</span><span class="s1">,&#39;</span>
        <span class="s1">&#39; CheckpointManagerOptions=</span><span class="si">%s</span><span class="s1">, root_directory=</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">multihost</span><span class="o">.</span><span class="n">process_index</span><span class="p">(),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_configure_checkpointer_common</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">handler</span><span class="p">:</span> <span class="n">CompositeCheckpointHandler</span><span class="p">,</span>
      <span class="n">options</span><span class="p">:</span> <span class="n">CheckpointManagerOptions</span><span class="p">,</span>
      <span class="n">use_async</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Checkpointer</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">use_async</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">async_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">async_checkpointer</span><span class="o">.</span><span class="n">AsyncCheckpointer</span><span class="p">(</span>
            <span class="n">handler</span><span class="p">,</span>
            <span class="n">timeout_secs</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">async_options</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">,</span>
            <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
            <span class="n">barrier_sync_fn</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">async_options</span><span class="o">.</span><span class="n">barrier_sync_fn</span><span class="p">,</span>
            <span class="n">active_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
            <span class="n">barrier_sync_key_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
            <span class="n">post_finalization_callback</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">async_options</span><span class="o">.</span><span class="n">post_finalization_callback</span><span class="p">,</span>
            <span class="n">path_permission_mode</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">file_options</span><span class="o">.</span><span class="n">path_permission_mode</span><span class="p">,</span>
            <span class="n">checkpoint_metadata_store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_non_blocking_checkpoint_metadata_store</span><span class="p">,</span>
            <span class="n">temporary_path_class</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">temporary_path_class</span><span class="p">,</span>
        <span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">async_checkpointer</span><span class="o">.</span><span class="n">AsyncCheckpointer</span><span class="p">(</span>
            <span class="n">handler</span><span class="p">,</span>
            <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
            <span class="n">active_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
            <span class="n">barrier_sync_key_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
            <span class="n">path_permission_mode</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">file_options</span><span class="o">.</span><span class="n">path_permission_mode</span><span class="p">,</span>
            <span class="n">checkpoint_metadata_store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_non_blocking_checkpoint_metadata_store</span><span class="p">,</span>
            <span class="n">temporary_path_class</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">temporary_path_class</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">Checkpointer</span><span class="p">(</span>
          <span class="n">handler</span><span class="p">,</span>
          <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
          <span class="n">active_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
          <span class="n">barrier_sync_key_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
          <span class="n">path_permission_mode</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">file_options</span><span class="o">.</span><span class="n">path_permission_mode</span><span class="p">,</span>
          <span class="n">checkpoint_metadata_store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocking_checkpoint_metadata_store</span><span class="p">,</span>
          <span class="n">temporary_path_class</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">temporary_path_class</span><span class="p">,</span>
      <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_configure_checkpointer_legacy_init</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">checkpointers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AbstractCheckpointer</span><span class="p">,</span> <span class="n">CheckpointersDict</span><span class="p">],</span>
      <span class="n">options</span><span class="p">:</span> <span class="n">CheckpointManagerOptions</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Checkpointer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes _CompositeCheckpointer with legacy style checkpointers.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="sa">f</span><span class="s1">&#39;`primary_host`=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="si">}</span><span class="s1"> is not&#39;</span>
          <span class="s1">&#39; supported in legacy API.&#39;</span>
      <span class="p">)</span>

    <span class="n">item_handlers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpointers</span><span class="p">,</span> <span class="n">Checkpointer</span><span class="p">):</span>
      <span class="n">use_async</span> <span class="o">=</span> <span class="n">is_async_checkpointer</span><span class="p">(</span><span class="n">checkpointers</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpointers</span><span class="p">,</span> <span class="n">async_checkpointer</span><span class="o">.</span><span class="n">AsyncCheckpointer</span><span class="p">):</span>
        <span class="n">async_timeout</span> <span class="o">=</span> <span class="n">checkpointers</span><span class="o">.</span><span class="n">_async_manager</span><span class="o">.</span><span class="n">_timeout_secs</span>  <span class="c1"># pylint: disable=protected-access</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">async_timeout</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">item_handlers</span><span class="p">[</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">checkpointers</span><span class="o">.</span><span class="n">handler</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpointers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="n">individual_use_async</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">async_timeout</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">item_name</span><span class="p">,</span> <span class="n">checkpointer</span> <span class="ow">in</span> <span class="n">checkpointers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpointer</span><span class="p">,</span> <span class="n">Checkpointer</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="sa">f</span><span class="s1">&#39;Value corresponding to </span><span class="si">{</span><span class="n">item_name</span><span class="si">}</span><span class="s1"> in `checkpointers` is not a&#39;</span>
              <span class="sa">f</span><span class="s1">&#39; Checkpointer. Found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">checkpointer</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
          <span class="p">)</span>
        <span class="n">individual_use_async</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_async_checkpointer</span><span class="p">(</span><span class="n">checkpointer</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpointer</span><span class="p">,</span> <span class="n">async_checkpointer</span><span class="o">.</span><span class="n">AsyncCheckpointer</span><span class="p">):</span>
          <span class="n">async_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
              <span class="n">async_timeout</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">_async_manager</span><span class="o">.</span><span class="n">_timeout_secs</span>  <span class="c1"># pylint: disable=protected-access</span>
          <span class="p">)</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">RESERVED_ITEM_NAMES</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="n">item_name</span><span class="si">}</span><span class="s1"> in `checkpointers`; this is a reserved key.&#39;</span>
          <span class="p">)</span>
        <span class="n">item_handlers</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">handler</span>
      <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">individual_use_async</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">individual_use_async</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Orbax `CheckpointManager` is transitioning toward using&#39;</span>
            <span class="s1">&#39; asynchronous saving logic under the hood in all cases. Users that&#39;</span>
            <span class="s1">&#39; configure `CheckpointManager` with some `Checkpointer`s and some&#39;</span>
            <span class="s1">&#39; `AsyncCheckpointer`s will now see asynchronous logic used to save&#39;</span>
            <span class="s1">&#39; all items. This may result in breakages if the code is assuming&#39;</span>
            <span class="s1">&#39; that certain objects will be available immediately after saving.&#39;</span>
            <span class="s1">&#39; Ensure that if you depend on the result of `save` being fully&#39;</span>
            <span class="s1">&#39; written at a particular moment, use `wait_until_finished()`.&#39;</span>
        <span class="p">)</span>
      <span class="n">use_async</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">individual_use_async</span><span class="p">)</span>
      <span class="n">async_timeout</span> <span class="o">=</span> <span class="n">async_timeout</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="sa">f</span><span class="s1">&#39;Invalid type for `checkpointers`. Found </span><span class="si">{</span><span class="n">checkpointers</span><span class="si">}</span><span class="s1">.&#39;</span>
      <span class="p">)</span>

    <span class="c1"># if options.best_fn:</span>
    <span class="n">item_handlers</span><span class="p">[</span><span class="n">METRIC_ITEM_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">JsonCheckpointHandler</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">METRIC_ITEM_NAME</span>
    <span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">async_options</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">async_options</span> <span class="ow">or</span> <span class="n">AsyncOptions</span><span class="p">(</span>
        <span class="n">timeout_secs</span><span class="o">=</span><span class="n">async_timeout</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure_checkpointer_common</span><span class="p">(</span>
        <span class="n">CompositeCheckpointHandler</span><span class="p">(</span>
            <span class="n">composite_options</span><span class="o">=</span><span class="n">composite_checkpoint_handler</span><span class="o">.</span><span class="n">CompositeOptions</span><span class="p">(</span>
                <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
                <span class="n">active_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
                <span class="n">barrier_sync_key_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="n">item_handlers</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">options</span><span class="p">,</span>
        <span class="n">use_async</span><span class="p">,</span>
    <span class="p">)</span>


  <span class="k">def</span> <span class="nf">_validate_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s1">&#39;_primary_host&#39;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">handler</span><span class="o">.</span><span class="n">_primary_host</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span>  <span class="c1"># pylint: disable=protected-access</span>
    <span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Inconsistent primary_host,&#39;</span>
          <span class="sa">f</span><span class="s1">&#39; CheckpointManager=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="si">}</span><span class="s1">, &#39;</span>
          <span class="sa">f</span><span class="s1">&#39;handler[</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="si">}</span><span class="s1">]=</span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">_primary_host</span><span class="si">}</span><span class="s1"> &#39;</span>  <span class="c1"># pylint: disable=protected-access</span>
      <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_configure_checkpointer</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">item_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
      <span class="n">item_handlers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CheckpointHandler</span><span class="p">,</span> <span class="n">CheckpointHandlersDict</span><span class="p">]],</span>
      <span class="n">options</span><span class="p">:</span> <span class="n">CheckpointManagerOptions</span><span class="p">,</span>
      <span class="n">single_item</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Checkpointer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes _CompositeCheckpointer given `item_names`.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="n">item_handlers</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;When primary_host is set to None, item_handlers must be provided to&#39;</span>
          <span class="s1">&#39; match with the primary_host setting.&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="n">single_item</span><span class="p">:</span>
      <span class="n">item_handler</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">item_handlers</span>
          <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_handlers</span><span class="p">,</span> <span class="n">CheckpointHandler</span><span class="p">)</span>
          <span class="k">else</span> <span class="kc">None</span>
      <span class="p">)</span>
      <span class="k">if</span> <span class="n">item_handler</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_handler</span><span class="p">(</span><span class="n">item_handler</span><span class="p">)</span>
      <span class="n">all_item_handlers</span> <span class="o">=</span> <span class="p">{</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">:</span> <span class="n">item_handler</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Initialize all_item_handlers with None or empty.</span>
      <span class="k">if</span> <span class="n">item_names</span><span class="p">:</span>
        <span class="n">all_item_handlers</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">item_names</span><span class="p">}</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">all_item_handlers</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="c1"># Update all_item_handlers with provided CheckpointHandlers.</span>
      <span class="k">if</span> <span class="n">item_handlers</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_handlers</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item_name</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">item_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_validate_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
          <span class="n">all_item_handlers</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>

    <span class="k">for</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">all_item_handlers</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">RESERVED_ITEM_NAMES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="n">item_name</span><span class="si">}</span><span class="s1"> in `checkpointers`; this is a reserved key.&#39;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">best_fn</span><span class="p">:</span>
      <span class="n">all_item_handlers</span><span class="p">[</span><span class="n">METRIC_ITEM_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">JsonCheckpointHandler</span><span class="p">(</span>
          <span class="n">filename</span><span class="o">=</span><span class="n">METRIC_ITEM_NAME</span><span class="p">,</span>
          <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
      <span class="p">)</span>
    <span class="c1"># CompositeCheckpointHandler defers per-item handler creation until</span>
    <span class="c1"># save/restore time.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure_checkpointer_common</span><span class="p">(</span>
        <span class="n">CompositeCheckpointHandler</span><span class="p">(</span>
            <span class="n">composite_options</span><span class="o">=</span><span class="n">composite_checkpoint_handler</span><span class="o">.</span><span class="n">CompositeOptions</span><span class="p">(</span>
                <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
                <span class="n">active_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
                <span class="n">barrier_sync_key_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="n">all_item_handlers</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">options</span><span class="p">,</span>
        <span class="n">options</span><span class="o">.</span><span class="n">enable_async_checkpointing</span><span class="p">,</span>
    <span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span>

<div class="viewcode-block" id="CheckpointManager.all_steps"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.all_steps">[docs]</a>  <span class="k">def</span> <span class="nf">all_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">read</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;`read` option is deprecated. Use `reload` to read from disk.&#39;</span>
      <span class="p">)</span>
      <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">checkpoint_steps</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">single_host_load_and_broadcast</span>
      <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ckpt</span><span class="o">.</span><span class="n">step</span> <span class="k">for</span> <span class="n">ckpt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">]</span></div>

<div class="viewcode-block" id="CheckpointManager.latest_step"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.latest_step">[docs]</a>  <span class="k">def</span> <span class="nf">latest_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CheckpointManager.best_step"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.best_step">[docs]</a>  <span class="k">def</span> <span class="nf">best_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_best</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_step</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">sorted_checkpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_checkpoints_by_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sorted_checkpoints</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">sorted_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span></div>

<div class="viewcode-block" id="CheckpointManager.reload"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.reload">[docs]</a>  <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reloads internal properties.</span>

<span class="sd">    Resets internal cache of checkpoint steps, in case the directory managed</span>
<span class="sd">    by this object has been updated externally.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_checkpoint_infos</span><span class="p">()</span></div>

<div class="viewcode-block" id="CheckpointManager.reached_preemption"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.reached_preemption">[docs]</a>  <span class="k">def</span> <span class="nf">reached_preemption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">reached_preemption</span><span class="p">(</span><span class="n">step</span><span class="p">)</span></div>

<div class="viewcode-block" id="CheckpointManager.should_save"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.should_save">[docs]</a>  <span class="k">def</span> <span class="nf">should_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is read only, save will be skipped&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reached_preemption</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="n">last_checkpoint_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_step</span><span class="p">()</span>
    <span class="c1"># Ensure current step is between the last step and next step (accounting for</span>
    <span class="c1"># save interval). The `last_checkpoint_step` may not be initialized, in</span>
    <span class="c1"># which case we should save. Otherwise, step must fall on the specified</span>
    <span class="c1"># save interval. This condition accounts for the possibility of saving</span>
    <span class="c1"># on preemption, in which case we want to maintain the same save period as</span>
    <span class="c1"># if preemption had not happened.</span>
    <span class="k">if</span> <span class="n">last_checkpoint_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_checkpoint_step</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># If present then prefer should_save_fn over other &#39;save_*&#39; options.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">should_save_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s1">&#39;CheckpointManagerOptions.should_save_fn is available, following save&#39;</span>
          <span class="s1">&#39; options will be ignored: save_interval_steps=</span><span class="si">%s</span><span class="s1"> and&#39;</span>
          <span class="s1">&#39; save_on_steps=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">save_interval_steps</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">save_on_steps</span><span class="p">,</span>
      <span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">should_save_fn</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">last_checkpoint_step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">last_checkpoint_step</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">save_interval_steps</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="ow">or</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">save_on_steps</span>
    <span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_get_save_directory</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
      <span class="n">directory</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the standardized path to a save directory for a single item.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">step_lib</span><span class="o">.</span><span class="n">build_step_path</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_name_format</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_write_step_directory</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_save_directory</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_read_step_directory</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">step_name_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">step_name_format</span><span class="o">.</span><span class="n">find_step</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_save_directory</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>

<div class="viewcode-block" id="CheckpointManager.delete"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.delete">[docs]</a>  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.</span>

<span class="sd">    Delete can be run asynchronously if</span>
<span class="sd">    CheckpointManagerOptions.enable_background_delete is set to True.</span>

<span class="sd">    Args:</span>
<span class="sd">      step: The step to delete.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is read only, delete will be skipped&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_steps</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Requested deleting a non-existent step: </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_deleter</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
    <span class="n">multihost</span><span class="o">.</span><span class="n">sync_global_processes</span><span class="p">(</span>
        <span class="n">multihost</span><span class="o">.</span><span class="n">unique_barrier_key</span><span class="p">(</span>
            <span class="s1">&#39;CheckpointManager:deleted_step&#39;</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">multihost</span><span class="o">.</span><span class="n">DIRECTORY_DELETION_TIMEOUT</span><span class="p">,</span>
        <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="n">step</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_validate_args</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">args_lib</span><span class="o">.</span><span class="n">CheckpointArgs</span><span class="p">],</span>
  <span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">CheckpointArgs</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Found an instance of `CheckpointArgs` provided for `items`. This may&#39;</span>
          <span class="s1">&#39; be due to misuse of the newer API - make sure to specify the&#39;</span>
          <span class="s1">&#39; argument keyword (e.g. `args=args`).&#39;</span>
      <span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">CheckpointArgs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Expected args of type `CheckpointArgs`; found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="s1">&#39;Cannot provide `args` of type `Composite` when dealing with a&#39;</span>
              <span class="s1">&#39; single checkpointable object.&#39;</span>
          <span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="s1">&#39;Must provide `args` of type `Composite` when dealing with&#39;</span>
              <span class="s1">&#39; multiple checkpointable objects.&#39;</span>
          <span class="p">)</span>

<div class="viewcode-block" id="CheckpointManager.save"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.save">[docs]</a>  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
      <span class="n">items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">save_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">SaveParams</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SaveParams</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PyTree</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">force</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">args_lib</span><span class="o">.</span><span class="n">CheckpointArgs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="n">step_stats</span> <span class="o">=</span> <span class="n">step_statistics</span><span class="o">.</span><span class="n">SaveStepStatistics</span><span class="p">()</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpoint_manager_blocking_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide `args` for `save`.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_save</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reached_preemption</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving checkpoint at step </span><span class="si">%d</span><span class="s1"> due to preemption.&#39;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
      <span class="n">step_stats</span><span class="o">.</span><span class="n">reached_preemption</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">step_stats</span><span class="o">.</span><span class="n">preemption_received_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Wait for ongoing saves to complete. Only applicable if some of the</span>
    <span class="c1"># checkpointers are AsyncCheckpointers.</span>
    <span class="c1"># Must happen after `should_save` to avoid blocking callers.</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">wait_for_prev_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">wait_for_prev_duration_secs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_stats</span><span class="o">.</span><span class="n">wait_for_prev_start_time</span>
    <span class="p">)</span>

    <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
        <span class="s1">&#39;/jax/checkpoint/write/wait_for_prev_duration_secs&#39;</span><span class="p">,</span>
        <span class="n">step_stats</span><span class="o">.</span><span class="n">wait_for_prev_duration_secs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_steps</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">StepAlreadyExistsError</span><span class="p">(</span>
          <span class="sa">f</span><span class="s1">&#39;Checkpoint for step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s1"> already exists.&#39;</span>
      <span class="p">)</span>

    <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">items</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">save_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">save_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
      <span class="n">items</span> <span class="o">=</span> <span class="p">{</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>
      <span class="n">save_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">:</span> <span class="n">save_kwargs</span><span class="p">}</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_best</span> <span class="ow">and</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Requested `tracked_metric`; did not provide metrics.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">args_dict</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">save_ckpt_arg_cls</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_args_for_key</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span>
            <span class="n">key</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">extra_args</span> <span class="o">=</span> <span class="n">save_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">save_kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">extra_args</span> <span class="o">=</span> <span class="n">extra_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">args_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_ckpt_arg_cls</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>  <span class="c1"># pytype: disable=wrong-arg-count</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">(</span><span class="o">**</span><span class="n">args_dict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="sa">f</span><span class="s1">&#39;Expected args of type `Composite`; found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
          <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">args_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_best</span><span class="p">:</span>
      <span class="n">args_dict</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">JsonSave</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">(</span><span class="o">**</span><span class="n">args_dict</span><span class="p">)</span>

    <span class="n">save_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_write_step_directory</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1"># If a folder for the step to save exists and is not finalized, remove the</span>
    <span class="c1"># existing folder.</span>
    <span class="k">if</span> <span class="n">step_lib</span><span class="o">.</span><span class="n">is_gcs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span>
          <span class="n">utils</span><span class="o">.</span><span class="n">is_primary_host</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">)</span>
          <span class="ow">and</span> <span class="n">save_directory</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
          <span class="ow">and</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_tmp_checkpoint</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>
      <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Attempting to save on GCS at step </span><span class="si">%s</span><span class="s1"> which has an unfinalized&#39;</span>
            <span class="s1">&#39; checkpoint from previous runs. Removing the unfinalized&#39;</span>
            <span class="s1">&#39; checkpoint before saving.&#39;</span><span class="p">,</span>
            <span class="n">step</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># make sure to use a synchronous deleter here</span>
        <span class="n">deleter</span><span class="o">.</span><span class="n">create_checkpoint_deleter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">todelete_subdir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_name_format</span><span class="p">,</span>
            <span class="n">enable_background_delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># no background thread</span>
        <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
      <span class="n">multihost</span><span class="o">.</span><span class="n">sync_global_processes</span><span class="p">(</span>
          <span class="n">multihost</span><span class="o">.</span><span class="n">unique_barrier_key</span><span class="p">(</span>
              <span class="s1">&#39;CheckpointManager:delete_unfinalized_step_gcs&#39;</span><span class="p">,</span>
              <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
              <span class="n">suffix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
          <span class="p">),</span>
          <span class="n">timeout</span><span class="o">=</span><span class="n">multihost</span><span class="o">.</span><span class="n">DIRECTORY_DELETION_TIMEOUT</span><span class="p">,</span>
          <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
      <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving checkpoint at step </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpointer_blocking_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_directory</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpointer_blocking_duration_secs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpointer_blocking_start_time</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_add_checkpoint_info</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">get_old_steps_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">steps_to_remove</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_old_steps_to_remove</span><span class="p">()</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">get_old_steps_duration_secs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_stats</span><span class="o">.</span><span class="n">get_old_steps_start_time</span>
    <span class="p">)</span>

    <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
        <span class="s1">&#39;/jax/checkpoint/write/get_old_steps_duration_secs&#39;</span><span class="p">,</span>
        <span class="n">step_stats</span><span class="o">.</span><span class="n">get_old_steps_duration_secs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">info</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">steps_to_remove</span>
    <span class="p">]</span>
    <span class="c1"># Sync needed to ensure that old steps to remove are retrieved before</span>
    <span class="c1"># actually deleting them during finalize, since retrieval can involve</span>
    <span class="c1"># looking at the directory.</span>
    <span class="n">multihost</span><span class="o">.</span><span class="n">sync_global_processes</span><span class="p">(</span>
        <span class="n">multihost</span><span class="o">.</span><span class="n">unique_barrier_key</span><span class="p">(</span>
            <span class="s1">&#39;CheckpointManager:old_steps_to_remove&#39;</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_thread</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_async_checkpointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beginning async checkpoint finalize.&#39;</span><span class="p">)</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">_FinalizeThread</span><span class="p">(</span>
          <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">save_directory</span><span class="p">,</span> <span class="n">steps_to_remove</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_thread</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span><span class="p">(</span><span class="n">save_directory</span><span class="p">,</span> <span class="n">steps_to_remove</span><span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished synchronous save.&#39;</span><span class="p">)</span>
      <span class="n">multihost</span><span class="o">.</span><span class="n">sync_global_processes</span><span class="p">(</span>
          <span class="n">multihost</span><span class="o">.</span><span class="n">unique_barrier_key</span><span class="p">(</span>
              <span class="s1">&#39;CheckpointManager:finalize&#39;</span><span class="p">,</span>
              <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
              <span class="n">suffix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
          <span class="p">),</span>
          <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
      <span class="p">)</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">synchronous</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_async_checkpointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">)</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpoint_manager_blocking_duration_secs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpoint_manager_blocking_start_time</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log_entry</span><span class="p">(</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">step_stats</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CheckpointManager.restore"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.restore">[docs]</a>  <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
      <span class="n">items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">restore_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
          <span class="n">Union</span><span class="p">[</span><span class="n">RestoreParams</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RestoreParams</span><span class="p">]]</span>
      <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">epath</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">args_lib</span><span class="o">.</span><span class="n">CheckpointArgs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">step_stats</span> <span class="o">=</span> <span class="n">step_statistics</span><span class="o">.</span><span class="n">RestoreStepStatistics</span><span class="p">()</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpoint_manager_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">items</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
      <span class="n">items</span> <span class="o">=</span> <span class="p">{</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">restore_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">restore_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
      <span class="n">restore_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">:</span> <span class="n">restore_kwargs</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">args_dict</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">item_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">restore_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item_keys</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">restore_ckpt_arg_cls</span> <span class="o">=</span> <span class="n">_get_args_for_key</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span>
            <span class="n">key</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">extra_args</span> <span class="o">=</span> <span class="n">restore_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">restore_kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">extra_args</span> <span class="o">=</span> <span class="n">extra_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">args_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">restore_ckpt_arg_cls</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>  <span class="c1"># pytype: disable=wrong-arg-count</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">(</span><span class="o">**</span><span class="n">args_dict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">restore_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_step_directory</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpointer_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">restored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">restore_directory</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpointer_duration_secs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpointer_start_time</span>
    <span class="p">)</span>

    <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpoint_manager_duration_secs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="o">-</span> <span class="n">step_stats</span><span class="o">.</span><span class="n">checkpoint_manager_start_time</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log_entry</span><span class="p">(</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">step_stats</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">restored</span><span class="p">[</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">restored</span></div>

<div class="viewcode-block" id="CheckpointManager.item_metadata"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.item_metadata">[docs]</a>  <span class="k">def</span> <span class="nf">item_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">args_lib</span><span class="o">.</span><span class="n">Composite</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="c1"># TODO(b/321751056): Move the validation to CompositeCheckpointHandler by</span>
    <span class="c1"># changing the current metadata() biz logic.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span> <span class="n">CompositeCheckpointHandler</span><span class="p">):</span>
      <span class="n">items_missing_handlers</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="p">(</span>
          <span class="n">item_name</span><span class="p">,</span>
          <span class="n">handler</span><span class="p">,</span>
      <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">_known_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># pylint: disable=protected-access</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">items_missing_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">items_missing_handlers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;No mapped CheckpointHandler found for items:&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">items_missing_handlers</span><span class="si">}</span><span class="s1">. Please see documentation of&#39;</span>
            <span class="s1">&#39; `item_handlers` in CheckpointManager.&#39;</span>
        <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_step_directory</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_item</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">DEFAULT_ITEM_NAME</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CheckpointManager.metrics"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.metrics">[docs]</a>  <span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PyTree</span><span class="p">]:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_best</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use handler directly, since this happens in a background thread and</span>
        <span class="c1"># barriers cannot be used. This usage pattern is generally not</span>
        <span class="c1"># recommended in other contexts.</span>
        <span class="k">return</span> <span class="n">JsonCheckpointHandler</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">METRIC_ITEM_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_step_directory</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">METRIC_ITEM_NAME</span>
        <span class="p">)</span>
      <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Missing metrics for step </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_track_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns true if we should track the best checkpoints by given metric.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">best_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">_load_checkpoint_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CheckpointInfo</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads a list of CheckpointInfo for existing checkpoints.</span>

<span class="sd">    If none are present, returns empty list.</span>

<span class="sd">    Returns:</span>
<span class="sd">      a list of CheckpointInfo, sorted by increasing step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">checkpoint_steps</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">single_host_load_and_broadcast</span>
    <span class="p">)</span>
    <span class="n">steps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Prefer in-place sort.</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">steps</span><span class="p">:</span>
      <span class="n">checkpoint_infos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>

      <span class="k">def</span> <span class="nf">build_checkpoint_info</span><span class="p">(</span><span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CheckpointInfo</span><span class="p">:</span>
        <span class="n">step_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_name_format</span><span class="o">.</span><span class="n">find_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CheckpointInfo</span><span class="p">(</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">step_metadata</span><span class="o">.</span><span class="n">commit_timestamp</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
        <span class="p">)</span>

      <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">step</span><span class="p">:</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">build_checkpoint_info</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span>
        <span class="p">}</span>
        <span class="n">checkpoint_infos</span> <span class="o">=</span> <span class="p">[</span><span class="n">futures</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">]</span>

    <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
        <span class="s1">&#39;/jax/checkpoint/read/load_all_step_metadata_duration_secs&#39;</span><span class="p">,</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Found </span><span class="si">%d</span><span class="s1"> checkpoint steps in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoint_infos</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">checkpoint_infos</span>

  <span class="k">def</span> <span class="nf">_get_interval_preserved_checkpoints</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">checkpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CheckpointInfo</span><span class="p">]</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CheckpointInfo</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets which checkpoints should be kept based on keep_time_interval.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoints</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[]</span>
    <span class="n">interval_preserved_checkpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_time_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">checkpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">info</span><span class="o">.</span><span class="n">time</span>
            <span class="o">&gt;=</span> <span class="n">interval_preserved_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_time_interval</span>
        <span class="p">):</span>
          <span class="n">interval_preserved_checkpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interval_preserved_checkpoints</span>

  <span class="k">def</span> <span class="nf">_add_checkpoint_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PyTree</span><span class="p">]):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">CheckpointInfo</span><span class="p">(</span>
            <span class="n">step</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="n">metrics</span>
        <span class="p">)</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_metadata_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">/</span> <span class="n">METADATA_ITEM_NAME</span>

  <span class="k">def</span> <span class="nf">_save_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves CheckpointManager level metadata, skips if already present.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_path</span><span class="p">()</span>
    <span class="n">path_exists</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="c1"># Ensure that we check across all processes before potentially saving.</span>
    <span class="n">multihost</span><span class="o">.</span><span class="n">sync_global_processes</span><span class="p">(</span>
        <span class="n">multihost</span><span class="o">.</span><span class="n">unique_barrier_key</span><span class="p">(</span>
            <span class="s1">&#39;CheckpointManager:check_metadata_existence&#39;</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_exists</span><span class="p">:</span>  <span class="c1"># May have been created by a previous run.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_checkpointer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

<div class="viewcode-block" id="CheckpointManager.metadata"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.metadata">[docs]</a>  <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_path</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_checkpointer</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span></div>

  <span class="k">def</span> <span class="nf">_sort_checkpoints_by_metrics</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">checkpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CheckpointInfo</span><span class="p">]</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">CheckpointInfo</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">CheckpointInfo</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sorts `checkpoints` in order of increasing metric quality.</span>

<span class="sd">    Checkpoints without corresponding metrics set will be at the beginning.</span>

<span class="sd">    Args:</span>
<span class="sd">      checkpoints: a list of CheckpointInfo.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Tuple of CheckpointInfo lists:</span>
<span class="sd">      (checkpoints_without_metrics, checkpoints_sorted_by_metrics)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">without_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">checkpoints</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">with_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">checkpoints</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">without_metrics</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">with_metrics</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">info</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">best_fn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">metrics</span><span class="p">),</span>
        <span class="n">reverse</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">best_mode</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_cleanup_tmp_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">cleanup_tmp_directories</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span>
        <span class="n">primary_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">,</span>
        <span class="n">active_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
        <span class="n">barrier_sync_key_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_old_steps_to_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns checkpoints that should be deleted.&quot;&quot;&quot;</span>
    <span class="c1"># Must have set max_to_keep in order to remove any checkpoints.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">max_to_keep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Not enough checkpoints accumulated to consider deletion.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">max_to_keep</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># This isn&#39;t a duration but there isn&#39;t a general counter that we can use so</span>
    <span class="c1"># we abuse a duration metric to count the number of steps examined.</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
        <span class="s1">&#39;/jax/checkpoint/write/old_steps_examined_count&#39;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Exclude the latest checkpoint, since it is not finalized.</span>
    <span class="n">are_locked</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">are_locked</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span><span class="n">info</span><span class="o">.</span><span class="n">step</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
        <span class="n">step_name_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_step_name_format</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">is_locked</span><span class="o">=</span><span class="n">is_locked</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">info</span><span class="p">,</span> <span class="n">is_locked</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">are_locked</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_best</span><span class="p">:</span>
      <span class="c1"># Best steps (to keep) are at the end, after sorting.</span>
      <span class="p">(</span>
          <span class="n">checkpoints_without_metrics</span><span class="p">,</span>
          <span class="n">sorted_checkpoints</span><span class="p">,</span>
      <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_checkpoints_by_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># checkpoints already sorted by ascending step</span>
      <span class="n">checkpoints_without_metrics</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">sorted_checkpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">max_to_keep</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_checkpoints_without_metrics</span><span class="p">:</span>
      <span class="n">maybe_delete</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">sorted_checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="n">keep</span><span class="p">]</span> <span class="k">if</span> <span class="n">keep</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sorted_checkpoints</span>
      <span class="p">)</span>
      <span class="n">active_checkpoints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
          <span class="n">checkpoints_without_metrics</span>
          <span class="o">+</span> <span class="p">(</span><span class="n">sorted_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="n">keep</span><span class="p">:]</span> <span class="k">if</span> <span class="n">keep</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[])</span>
      <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">all_checkpoints</span> <span class="o">=</span> <span class="n">checkpoints_without_metrics</span> <span class="o">+</span> <span class="n">sorted_checkpoints</span>
      <span class="n">maybe_delete</span> <span class="o">=</span> <span class="n">all_checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="n">keep</span><span class="p">]</span> <span class="k">if</span> <span class="n">keep</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sorted_checkpoints</span>
      <span class="n">active_checkpoints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="n">keep</span><span class="p">:]</span> <span class="k">if</span> <span class="n">keep</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[])</span>

    <span class="n">interval_preserved_checkpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_interval_preserved_checkpoints</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span>
    <span class="p">)</span>
    <span class="n">kept_checkpoints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">maybe_delete</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">is_locked</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Preserving </span><span class="si">%s</span><span class="s1">: (Reason: checkpoint is locked).&#39;</span><span class="p">,</span>
            <span class="n">info</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kept_checkpoints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_time_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
          <span class="ow">and</span> <span class="n">interval_preserved_checkpoints</span>
      <span class="p">):</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">interval_preserved_checkpoints</span><span class="p">:</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
              <span class="s1">&#39;Preserving </span><span class="si">%s</span><span class="s1">: (Reason: older falling on keep_time_interval).&#39;</span><span class="p">,</span>
              <span class="n">info</span><span class="p">,</span>
          <span class="p">)</span>
          <span class="n">kept_checkpoints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
          <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="p">(</span>
            <span class="n">interval_preserved_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_time_interval</span>
        <span class="p">):</span>
          <span class="n">interval_preserved_checkpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
              <span class="s1">&#39;Preserving </span><span class="si">%s</span><span class="s1">: (Reason: latest falling on keep_time_interval).&#39;</span><span class="p">,</span>
              <span class="n">info</span><span class="p">,</span>
          <span class="p">)</span>
          <span class="n">kept_checkpoints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
          <span class="k">continue</span>
      <span class="k">if</span> <span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
          <span class="ow">and</span> <span class="n">info</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_period</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Preserving </span><span class="si">%s</span><span class="s1">: (Reason: on keep_period=</span><span class="si">%s</span><span class="s1">).&#39;</span><span class="p">,</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="o">.</span><span class="n">keep_period</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kept_checkpoints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">kept_checkpoints</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">active_checkpoints</span><span class="p">)</span>

    <span class="n">steps_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">info</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kept_checkpoints</span><span class="p">:</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;worse metric&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_best</span> <span class="k">else</span> <span class="s1">&#39;old checkpoint&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting </span><span class="si">%s</span><span class="s1">: (Reason: </span><span class="si">%s</span><span class="s1">).&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="n">steps_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">steps_to_remove</span>

  <span class="k">def</span> <span class="nf">_wait_for_checkpointers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_async_checkpointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>  <span class="c1"># pytype: disable=attribute-error</span>

<div class="viewcode-block" id="CheckpointManager.wait_until_finished"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.wait_until_finished">[docs]</a>  <span class="k">def</span> <span class="nf">wait_until_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_thread</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint:disable=broad-exception-caught</span>
        <span class="c1"># If an exception occurred in the in finalization of the previous</span>
        <span class="c1"># save, we clean up since that checkpoint was never actually saved.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">e</span>
      <span class="k">finally</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_thread</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="c1"># Additional work is being done on process 0 of the finalize threads.</span>
      <span class="c1"># When joining the threads, we must wait for all threads to complete</span>
      <span class="c1"># before proceeding.</span>
      <span class="n">latest_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_step</span><span class="p">()</span>
      <span class="n">multihost</span><span class="o">.</span><span class="n">sync_global_processes</span><span class="p">(</span>
          <span class="n">multihost</span><span class="o">.</span><span class="n">unique_barrier_key</span><span class="p">(</span>
              <span class="s1">&#39;CheckpointManager:join_finalize_thread&#39;</span><span class="p">,</span>
              <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">barrier_sync_key_prefix</span><span class="p">,</span>
              <span class="n">suffix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">latest_step</span><span class="p">),</span>
          <span class="p">),</span>
          <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">active_processes</span><span class="p">,</span>
      <span class="p">)</span></div>

<div class="viewcode-block" id="CheckpointManager.is_saving_in_progress"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.is_saving_in_progress">[docs]</a>  <span class="k">def</span> <span class="nf">is_saving_in_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns whether a checkpoint save is in progress.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CheckpointManager.check_for_errors"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.check_for_errors">[docs]</a>  <span class="k">def</span> <span class="nf">check_for_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_async_checkpointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">check_for_errors</span><span class="p">()</span>  <span class="c1"># pytype: disable=attribute-error</span></div>

  <span class="k">def</span> <span class="nf">_finalize_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Executes final actions just before the checkpoint write completes.</span>

<span class="sd">    * Logs error if any.</span>
<span class="sd">    * Records duration saved due to preemption if any.</span>

<span class="sd">    Args:</span>
<span class="sd">      step: finalized checkpoint step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_primary_host</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_multiprocessing_options</span><span class="o">.</span><span class="n">primary_host</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_errors</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s1">&#39;Received error: </span><span class="si">%s</span><span class="s1"> from Checkpointer. One or more items may&#39;</span>
                <span class="s1">&#39; not be finalized. Skipping finalization of step checkpoint.&#39;</span>
            <span class="p">),</span>
            <span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
      <span class="c1"># If at a preemption step, record the time since the previous checkpoint.</span>
      <span class="c1"># This represents training time that would otherwise have been wasted.</span>
      <span class="c1"># If another checkpoint has not been previously saved, measures the time</span>
      <span class="c1"># since program start.</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reached_preemption</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">previous_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">previous_time</span> <span class="o">=</span> <span class="n">_INIT_TIME</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">previous_time</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
            <span class="s1">&#39;/jax/checkpoint/write/preempt/duration_saved_secs&#39;</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
        <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">steps_to_remove</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finalizes individual items and starts garbage collection.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_non_blocking_checkpoint_metadata_store</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_checkpointers</span><span class="p">()</span>
    <span class="c1"># If an error is encountered while waiting for commit futures to complete,</span>
    <span class="c1"># we will not proceed past this point.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_checkpoint</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">step_from_checkpoint_name</span><span class="p">(</span><span class="n">directory</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">remove_steps_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_deleter</span><span class="o">.</span><span class="n">delete_steps</span><span class="p">(</span><span class="n">steps_to_remove</span><span class="p">)</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
        <span class="s1">&#39;/jax/checkpoint/write/remove_steps_duration_secs&#39;</span><span class="p">,</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">remove_steps_start_time</span><span class="p">,</span>
    <span class="p">)</span>

<div class="viewcode-block" id="CheckpointManager.close"><a class="viewcode-back" href="../../../api_reference/checkpoint.checkpoint_manager.html#orbax.checkpoint.checkpoint_manager.CheckpointManager.close">[docs]</a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_finished</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Call after checkpointer.close().</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_non_blocking_checkpoint_metadata_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_checkpoint_metadata_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_deleter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

  <span class="k">def</span> <span class="nf">__contextmanager__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">yield</span> <span class="bp">self</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Orbax Contributors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024, Google.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrape6c2.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-themee6c2.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>

<!-- Mirrored from orbax.readthedocs.io/en/latest/_modules/orbax/checkpoint/checkpoint_manager.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Jul 2024 12:12:01 GMT -->
</html>