

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  
<!-- Mirrored from orbax.readthedocs.io/en/latest/_modules/orbax/checkpoint/type_handlers.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Jul 2024 12:12:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>orbax.checkpoint.type_handlers &#8212; Orbax  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/themee6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrape6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-themee6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.mine6c2.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/katex-math.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" />
    <link rel="stylesheet" type="text/css" href="https://orbax.readthedocs.io/_/static/css/badge_only.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrape6c2.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-themee6c2.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.mine6c2.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js"></script>
    <script src="../../../_static/katex.min.js"></script>
    <script src="../../../_static/auto-render.min.js"></script>
    <script src="../../../_static/katex_autorenderer.js"></script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://orbax.readthedocs.io/_/static/javascript/readthedocs-doc-embed.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/orbax/checkpoint/type_handlers';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  
<!-- RTD Extra Head -->

<link rel="stylesheet" href="https://orbax.readthedocs.io/_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/docs/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "_modules/orbax/checkpoint/type_handlers", "programming_language": "py", "project": "orbax", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_book_theme", "user_analytics_code": "", "version": "latest"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="https://orbax.readthedocs.io/_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="https://orbax.readthedocs.io/en/latest/search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index-2.html">
  
  
  
  
  
  
    <p class="title logo__title">Orbax  documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Checkpointing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_checkpoint_announcements.html">Announcements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_checkpoint_101.html">Checkpointing with Orbax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_checkpoint_api_overview.html">API Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_refactor.html">Using the Refactored CheckpointManager API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpointing_pytrees.html">Checkpointing PyTrees of Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint_format.html">Checkpoint Format Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimized_checkpointing.html">Optimized Checkpointing with Tensorstore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_handlers.html">Customizing Checkpointing Logic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transformations.html">Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../preemption_checkpointing.html">Preemption Tolerance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../async_checkpointing.html">Asynchronous Checkpointing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api_reference/checkpoint.html">orbax.checkpoint API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.abstract_checkpoint_manager.html">AbstractCheckpointManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpoint_manager.html">CheckpointManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpointers.html">Checkpointers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpoint_handlers.html">CheckpointHandlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.args.html">CheckpointArgs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.type_handlers.html">TypeHandlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.path.atomicity.html">Atomicity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.path.step.html">Step entities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.path.deleter.html">Checkpoint Deleter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.checkpoint_utils.html">Checkpointing Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.utils.html">General Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.transform_utils.html">PyTree Transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.msgpack_utils.html">Msgpack utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.multihost.html">Multi-host Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.tree.html">Tree Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.metadata.html">Metadata Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/checkpoint.logging.html">Checkpoint logging</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Exporting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../orbax_export_101.html">Exporting with Orbax</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api_reference/export.html">orbax.export API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.dtensor_utils.html">DTensor utilities for multi-device/host export</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.export_manager.html">ExportManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.export_manager_base.html">ExportManagerBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.jax_module.html">JaxModule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.serving_config.html">ServingConfig</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.utils.html">General Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.validate.validation_manager.html">ValidationManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/export.validate.validation_report.html">ValidationReport</a></li>

</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Information</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">

  <div id="ethical-ad-placement"
       class="flat"
       data-ea-publisher="readthedocs"
       data-ea-type="readthedocs-sidebar"
       data-ea-manual="true">
  </div>
</div>
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for orbax.checkpoint.type_handlers</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2024 The Orbax Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Provides utils for PytreeCheckpointHandler.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">etils</span> <span class="kn">import</span> <span class="n">epath</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">future</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">multihost</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.metadata</span> <span class="kn">import</span> <span class="n">sharding</span> <span class="k">as</span> <span class="n">sharding_metadata</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.metadata</span> <span class="kn">import</span> <span class="n">value</span> <span class="k">as</span> <span class="n">value_metadata</span>
<span class="kn">from</span> <span class="nn">orbax.checkpoint.path</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">path_utils</span>
<span class="kn">import</span> <span class="nn">tensorstore</span> <span class="k">as</span> <span class="nn">ts</span>

<span class="n">Scalar</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">]</span>
<span class="n">Metadata</span> <span class="o">=</span> <span class="n">value_metadata</span><span class="o">.</span><span class="n">Metadata</span>
<span class="n">NamedSharding</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">NamedSharding</span>
<span class="n">ScalarMetadata</span> <span class="o">=</span> <span class="n">value_metadata</span><span class="o">.</span><span class="n">ScalarMetadata</span>
<span class="n">ArrayMetadata</span> <span class="o">=</span> <span class="n">value_metadata</span><span class="o">.</span><span class="n">ArrayMetadata</span>
<span class="n">StringMetadata</span> <span class="o">=</span> <span class="n">value_metadata</span><span class="o">.</span><span class="n">StringMetadata</span>
<span class="n">ShardingMetadata</span> <span class="o">=</span> <span class="n">sharding_metadata</span><span class="o">.</span><span class="n">ShardingMetadata</span>
<span class="n">_OCDBT_MANIFEST_FILE</span> <span class="o">=</span> <span class="s1">&#39;manifest.ocdbt&#39;</span>
<span class="n">_BASE_TS_CONTEXT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;file_io_concurrency&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">},</span>
<span class="p">}</span>
<span class="n">_DEFAULT_OCDBT_TS_CONTEXT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">_BASE_TS_CONTEXT</span><span class="p">,</span>
    <span class="c1"># Provide cache pool for B-tree nodes to avoid repeated reads.</span>
    <span class="c1"># 100MB limit.</span>
    <span class="o">**</span><span class="p">{</span><span class="s1">&#39;cache_pool#ocdbt&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_bytes_limit&#39;</span><span class="p">:</span> <span class="mi">100000000</span><span class="p">}},</span>
<span class="p">}</span>

<span class="n">RESTORE_TYPE_NONE</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
<span class="n">RESTORE_TYPE_DICT</span> <span class="o">=</span> <span class="s1">&#39;Dict&#39;</span>
<span class="n">RESTORE_TYPE_LIST</span> <span class="o">=</span> <span class="s1">&#39;List&#39;</span>
<span class="n">RESTORE_TYPE_UNKNOWN</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>

<span class="n">_DEFAULT_DRIVER</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
<span class="n">_PROCESS_SUBDIR_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;ocdbt.process_&#39;</span>
<span class="n">_OCDBT_PROCESS_ID_RE</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[A-Za-z0-9]+&#39;</span>
<span class="n">_SHARDING</span> <span class="o">=</span> <span class="s1">&#39;_sharding&#39;</span>

<span class="n">ZARR_VER2</span> <span class="o">=</span> <span class="s1">&#39;zarr&#39;</span>
<span class="n">ZARR_VER3</span> <span class="o">=</span> <span class="s1">&#39;zarr3&#39;</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_assert_parameter_files_exist</span><span class="p">(</span>
    <span class="n">param_dir</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_zarr3</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks for existence of parameter subdir and .zarray file.&quot;&quot;&quot;</span>
  <span class="n">exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">path_utils</span><span class="o">.</span><span class="n">async_exists</span><span class="p">(</span><span class="n">param_dir</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;Individual parameter subdirectory not found at path: </span><span class="si">{</span><span class="n">param_dir</span><span class="si">}</span><span class="s1">.&#39;</span>
    <span class="p">)</span>
  <span class="k">if</span> <span class="n">metadata_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">metadata_key</span> <span class="o">=</span> <span class="s1">&#39;zarr.json&#39;</span> <span class="k">if</span> <span class="n">use_zarr3</span> <span class="k">else</span> <span class="s1">&#39;.zarray&#39;</span>
  <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">param_dir</span> <span class="o">/</span> <span class="n">metadata_key</span>
  <span class="n">exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">path_utils</span><span class="o">.</span><span class="n">async_exists</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;File not found: </span><span class="si">{</span><span class="n">metadata_path</span><span class="si">}</span><span class="s1">. In many cases, this results from&#39;</span>
        <span class="s1">&#39; copying a checkpoint without using the `-a` flag.&#39;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">is_supported_empty_aggregation_type</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Determines if the *empty* value is supported for aggregation.&quot;&quot;&quot;</span>
  <span class="c1"># Check isinstance first to avoid `not` checks on jax.Arrays (raises error).</span>
  <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">is_supported_aggregation_type</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Determines if the value is supported for aggregation.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span>
      <span class="n">value</span><span class="p">,</span>
      <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">),</span>
  <span class="p">)</span> <span class="ow">or</span> <span class="n">is_supported_empty_aggregation_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_empty_value_typestr</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">is_supported_empty_aggregation_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1"> is not a supported empty aggregation type.&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RESTORE_TYPE_LIST</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RESTORE_TYPE_DICT</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">RESTORE_TYPE_NONE</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized empty type: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_empty_typestr</span><span class="p">(</span><span class="n">typestr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="k">return</span> <span class="p">(</span>
      <span class="n">typestr</span> <span class="o">==</span> <span class="n">RESTORE_TYPE_LIST</span>
      <span class="ow">or</span> <span class="n">typestr</span> <span class="o">==</span> <span class="n">RESTORE_TYPE_DICT</span>
      <span class="ow">or</span> <span class="n">typestr</span> <span class="o">==</span> <span class="n">RESTORE_TYPE_NONE</span>
  <span class="p">)</span>


<span class="k">def</span> <span class="nf">get_empty_value_from_typestr</span><span class="p">(</span><span class="n">typestr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">typestr</span> <span class="o">==</span> <span class="n">RESTORE_TYPE_LIST</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[]</span>
  <span class="k">elif</span> <span class="n">typestr</span> <span class="o">==</span> <span class="n">RESTORE_TYPE_DICT</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{}</span>
  <span class="k">elif</span> <span class="n">typestr</span> <span class="o">==</span> <span class="n">RESTORE_TYPE_NONE</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized typestr: </span><span class="si">{</span><span class="n">typestr</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LimitInFlightBytes</span><span class="p">(</span><span class="n">serialization</span><span class="o">.</span><span class="n">_LimitInFlightBytes</span><span class="p">):</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Limits in-flight bytes when reading/writing checkpoints per process.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">wait_for_bytes_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requested_bytes</span><span class="p">):</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_for_bytes</span><span class="p">(</span><span class="n">requested_bytes</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">release_bytes_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requested_bytes</span><span class="p">):</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release_bytes</span><span class="p">(</span><span class="n">requested_bytes</span><span class="p">))</span>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">ParamInfo</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Information describing a parameter in a PyTree.</span>

<span class="sd">  Note that ParamInfo is distinct from SaveArgs and RestoreArgs in that in</span>
<span class="sd">  represents information not provided by a user, and should be computed</span>
<span class="sd">  internally.</span>

<span class="sd">  name:</span>
<span class="sd">    Name of the parameter.</span>
<span class="sd">  path:</span>
<span class="sd">    A path providing a location where file(s) should be saved. The path is</span>
<span class="sd">    assumed to be a directory.</span>
<span class="sd">  parent_dir:</span>
<span class="sd">    A path providing location where all files under the same checkpoint should</span>
<span class="sd">    be saved under. All `ParamInfo` provided to a given TypeHandler should have</span>
<span class="sd">    the same `parent_dir`. The parent_dir is assumed to be a directory.</span>
<span class="sd">  skip_deserialize:</span>
<span class="sd">    If specified, skips deserialization of the given parameter using the</span>
<span class="sd">    TypeHandler. This may be for multiple different reasons, including that the</span>
<span class="sd">    parameter may have been aggregated, or it will be unneeded after</span>
<span class="sd">    transformations. Note: this parameter is handled by PyTreeCheckpointHandler,</span>
<span class="sd">    so it is unnecessary for TypeHandler implementations to deal with it.</span>
<span class="sd">  byte_limiter:</span>
<span class="sd">    Object to limit the number of bytes that can be read in</span>
<span class="sd">    parallel.</span>
<span class="sd">  is_ocdbt_checkpoint:</span>
<span class="sd">    Indicates whether the checkpoint path uses OCDBT format</span>
<span class="sd">    or not. Only used for restoration.</span>
<span class="sd">  use_zarr3:</span>
<span class="sd">    If True, use Zarr ver3 otherwise ver2.</span>
<span class="sd">  ocdbt_target_data_file_size:</span>
<span class="sd">    Specifies the target size (in bytes) of each OCDBT data file.</span>
<span class="sd">  ts_context:</span>
<span class="sd">    Tensorstore context to use for reading/writing.</span>
<span class="sd">  value_typestr: stores the original value&#39;s typestr (from TypeHandler).</span>
<span class="sd">    Only required when saving.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">parent_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">skip_deserialize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">byte_limiter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">serialization</span><span class="o">.</span><span class="n">_LimitInFlightBytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pylint: disable=protected-access</span>
  <span class="n">is_ocdbt_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">use_zarr3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">ocdbt_target_data_file_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">ts_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ts</span><span class="o">.</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">value_typestr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="SaveArgs"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.SaveArgs">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">SaveArgs</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Extra arguments that can be provided for saving.</span>

<span class="sd">  aggregate:</span>
<span class="sd">    Deprecated, please use custom TypeHandler</span>
<span class="sd">    (https://orbax.readthedocs.io/en/latest/custom_handlers.html#typehandler) or</span>
<span class="sd">    contact Orbax team to migrate before August 1st, 2024. If true, saves the</span>
<span class="sd">    given</span>
<span class="sd">    parameter in an aggregated tree format rather than individually. See</span>
<span class="sd">    AggregateHandler.</span>
<span class="sd">  dtype:</span>
<span class="sd">    If provided, casts the parameter to the given dtype before saving.</span>
<span class="sd">    Note that the parameter must be compatible with the given type (e.g.</span>
<span class="sd">    jnp.bfloat16 is not compatible with np.ndarray).</span>
<span class="sd">  write_chunk_shape:</span>
<span class="sd">    This only applies to Zarr version 3.  This specifies the shape of a shard</span>
<span class="sd">    used in writing.  The default(None) is set to equal to the array shard size,</span>
<span class="sd">    so there are equal number of write chunks and shards. The write_chunk_shape</span>
<span class="sd">    needs to be a divisor of the array shape.</span>
<span class="sd">  read_chunk_shape:</span>
<span class="sd">    This only applies to Zarr version 3.  This specifies the chunk sizes within</span>
<span class="sd">    a write chunk. Default is set to equal to the write_chunk_shape. The</span>
<span class="sd">    read_chunk_shape is required to be a divisor of the write_chunk_shape.</span>
<span class="sd">  chunk_byte_size:</span>
<span class="sd">    This is an experimental feature that automatically chooses the largest chunk</span>
<span class="sd">    shape possible, while keeping the chunk byte size less than or equal to the</span>
<span class="sd">    specified chunk_byte_size. Both the write_chunk_shape and read_chunk_shape</span>
<span class="sd">    are automatically set to the chosen shape. This uses a greedy algorithm that</span>
<span class="sd">    prioritizes splitting the largest dimensions first. In order to enable this</span>
<span class="sd">    feature, both write_chunk_shape and read_chunk_shape must be set to None.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">aggregate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">write_chunk_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">read_chunk_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">chunk_byte_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">log_every_n_seconds</span><span class="p">(</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
          <span class="s1">&#39;SaveArgs.aggregate is deprecated, please use custom TypeHandler&#39;</span>
          <span class="s1">&#39; (https://orbax.readthedocs.io/en/latest/custom_handlers.html#typehandler)&#39;</span>
          <span class="s1">&#39; or contact Orbax team to migrate before August 1st, 2024.&#39;</span><span class="p">,</span>
          <span class="n">n_seconds</span><span class="o">=</span><span class="mi">12</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># once every 12 hours</span>
      <span class="p">)</span></div>


<div class="viewcode-block" id="RestoreArgs"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.RestoreArgs">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">RestoreArgs</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Extra arguments that can be provided for restoration.</span>

<span class="sd">  restore_type:</span>
<span class="sd">    Specifies the object type of the restored parameter. The type</span>
<span class="sd">    must have a corresponding TypeHandler for restoration. Ignored if the</span>
<span class="sd">    parameter is restored from an aggregated checkpoint file.</span>
<span class="sd">  dtype:</span>
<span class="sd">    If provided, casts the parameter to the given dtype after restoring.</span>
<span class="sd">    Note that the parameter must be compatible with the given type (e.g.</span>
<span class="sd">    jnp.bfloat16 is not compatible with np.ndarray).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">restore_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<span class="k">def</span> <span class="nf">_choose_chunk_shape</span><span class="p">(</span>
    <span class="n">global_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">write_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>
    <span class="n">target_byte_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Chooses a chunk shape that divides the `write_shape`.</span>

<span class="sd">  The chunk shape is chosen such that the resulting byte size is less than</span>
<span class="sd">  or equal to `target_byte_size`, but is otherwise as large as possible.</span>

<span class="sd">  This uses a greedy algorithm that attempts to split the largest and sharded</span>
<span class="sd">  dimensions first.</span>

<span class="sd">  Args:</span>
<span class="sd">    global_shape: the global shape of the array</span>
<span class="sd">    write_shape: the local shape being written</span>
<span class="sd">    dtype: the dtype of the array</span>
<span class="sd">    target_byte_size: Desired chunk byte size.  Must be &gt;= dtype.itemsize.</span>

<span class="sd">  Returns:</span>
<span class="sd">    List of length `len(write_shape)` specifying the chosen chunk shape.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">global_shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">write_shape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">target_byte_size</span> <span class="o">&lt;</span> <span class="mi">1048576</span><span class="p">:</span>  <span class="c1"># 1 MB</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s1">&#39;Setting the target_byte_size too small could reduce performance.&#39;</span>
    <span class="p">)</span>

  <span class="n">sharded_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">global_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">write_shape</span><span class="p">)</span>
  <span class="n">dtype_size</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
  <span class="n">target_elements</span> <span class="o">=</span> <span class="n">target_byte_size</span> <span class="o">//</span> <span class="n">dtype_size</span>

  <span class="n">rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">write_shape</span><span class="p">)</span>

  <span class="c1"># `dim_factors[i]` is the list of divisors of `write_shape[i]`</span>
  <span class="n">dim_factors</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">size</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">write_shape</span>
  <span class="p">]</span>

  <span class="c1"># The current chunk shape is:</span>
  <span class="c1"># [dim_factors[i][-1] for i in range(rank)]</span>

  <span class="k">def</span> <span class="nf">get_total_elements</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the number of elements in the current chunk shape.&quot;&quot;&quot;</span>
    <span class="n">total_elements</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
      <span class="n">total_elements</span> <span class="o">*=</span> <span class="n">dim_factors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total_elements</span>

  <span class="c1"># Reduce the current chunk shape until the desired number of elements is</span>
  <span class="c1"># reached.</span>
  <span class="k">while</span> <span class="n">get_total_elements</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">target_elements</span><span class="p">:</span>
    <span class="c1"># Greedily reduce the largest dimension.  This is not guaranteed to bring us</span>
    <span class="c1"># the closest to `target_elements`, but is simple to implement and should</span>
    <span class="c1"># work well enough.</span>
    <span class="n">dim_to_reduce</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">dim_to_reduce_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">dim_factors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">sharded_dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">dim_to_reduce_size</span><span class="p">:</span>
        <span class="n">dim_to_reduce_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">dim_to_reduce</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">if</span> <span class="n">dim_to_reduce_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">dim_factors</span><span class="p">[</span><span class="n">dim_to_reduce</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># need to start splitting on unsharded dimension</span>
      <span class="n">sharded_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">write_shape</span><span class="p">))</span>

  <span class="n">chosen_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim_factors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank</span><span class="p">)]</span>

  <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
      <span class="s1">&#39;global_shape=</span><span class="si">%s</span><span class="s1">, write_shape=</span><span class="si">%s</span><span class="s1">, dtype=</span><span class="si">%s</span><span class="s1">, target_byte_size=</span><span class="si">%d</span><span class="s1">,&#39;</span>
      <span class="s1">&#39; chosen_shape=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">global_shape</span><span class="p">,</span>
      <span class="n">write_shape</span><span class="p">,</span>
      <span class="n">dtype</span><span class="p">,</span>
      <span class="n">target_byte_size</span><span class="p">,</span>
      <span class="n">chosen_shape</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="n">chosen_shape</span>


<span class="k">def</span> <span class="nf">_validate_divisible_shapes</span><span class="p">(</span>
    <span class="n">shape1</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">shape2</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Return True if shape2 is a divisor of shape1 otherwise False.&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">shape1</span><span class="p">,</span> <span class="n">shape2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="c1"># eg. imcompatible shape</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># TS functions</span>
<span class="c1"># TODO(b/336658919) refractor TS functions to a separate file</span>
<span class="k">def</span> <span class="nf">_get_json_tspec</span><span class="p">(</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
    <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">process_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec in JSON format.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must construct serialization path.&#39;</span><span class="p">)</span>
  <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span><span class="p">)</span>
  <span class="n">tspec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_tensorstore_spec</span><span class="p">(</span>
      <span class="n">directory</span><span class="p">,</span>
      <span class="n">name</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
      <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">,</span>
      <span class="n">process_id</span><span class="o">=</span><span class="n">process_index</span><span class="p">,</span>
      <span class="n">use_zarr3</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">use_zarr3</span><span class="p">,</span>
      <span class="n">ocdbt_target_data_file_size</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ocdbt_target_data_file_size</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="k">if</span> <span class="n">metadata_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_key</span>
  <span class="k">return</span> <span class="n">tspec</span>


<div class="viewcode-block" id="get_json_tspec_read"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.get_json_tspec_read">[docs]</a><span class="k">def</span> <span class="nf">get_json_tspec_read</span><span class="p">(</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
    <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec for reading.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">_get_json_tspec</span><span class="p">(</span>
      <span class="n">info</span><span class="p">,</span>
      <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">,</span>
      <span class="n">metadata_key</span><span class="o">=</span><span class="n">metadata_key</span><span class="p">,</span>
  <span class="p">)</span></div>


<div class="viewcode-block" id="get_json_tspec_write"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.get_json_tspec_write">[docs]</a><span class="k">def</span> <span class="nf">get_json_tspec_write</span><span class="p">(</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
    <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">global_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">local_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>
    <span class="n">process_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">arg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec for writing.&quot;&quot;&quot;</span>
  <span class="n">tspec</span> <span class="o">=</span> <span class="n">_get_json_tspec</span><span class="p">(</span>
      <span class="n">info</span><span class="p">,</span>
      <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">,</span>
      <span class="n">process_index</span><span class="o">=</span><span class="n">process_index</span><span class="p">,</span>
      <span class="n">metadata_key</span><span class="o">=</span><span class="n">metadata_key</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">global_shape</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
      <span class="n">_build_ts_zarr_shard_and_chunk_metadata</span><span class="p">(</span>
          <span class="n">global_shape</span><span class="o">=</span><span class="n">global_shape</span><span class="p">,</span>
          <span class="n">shard_shape</span><span class="o">=</span><span class="n">local_shape</span><span class="p">,</span>
          <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
          <span class="n">use_zarr3</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">use_zarr3</span><span class="p">,</span>
          <span class="n">write_chunk_shape</span><span class="o">=</span><span class="n">arg</span><span class="o">.</span><span class="n">write_chunk_shape</span> <span class="k">if</span> <span class="n">arg</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">read_chunk_shape</span><span class="o">=</span><span class="n">arg</span><span class="o">.</span><span class="n">read_chunk_shape</span> <span class="k">if</span> <span class="n">arg</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">chunk_byte_size</span><span class="o">=</span><span class="n">arg</span><span class="o">.</span><span class="n">chunk_byte_size</span> <span class="k">if</span> <span class="n">arg</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
      <span class="p">)</span>
  <span class="p">)</span>
  <span class="k">if</span> <span class="n">use_ocdbt</span><span class="p">:</span>
    <span class="n">tspec</span> <span class="o">=</span> <span class="n">_add_write_tspec_ocdbt_options</span><span class="p">(</span><span class="n">tspec</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tspec</span></div>


<span class="k">def</span> <span class="nf">_build_ts_zarr_shard_and_chunk_metadata</span><span class="p">(</span>
    <span class="n">global_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">shard_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">use_zarr3</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>
    <span class="n">write_chunk_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">read_chunk_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chunk_byte_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;This function returns the TS metadata for write spec.&quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="p">(</span>
      <span class="n">write_chunk_shape</span> <span class="ow">or</span> <span class="n">read_chunk_shape</span> <span class="ow">or</span> <span class="n">chunk_byte_size</span>
  <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_zarr3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s1">&#39;Zarr3 is not enabled when `write_chunk_shape`, `read_chunk_shape` or&#39;</span>
        <span class="s1">&#39; `chunk_byte_size` is specified.&#39;</span>
    <span class="p">)</span>

  <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">use_zarr3</span><span class="p">:</span>
    <span class="c1"># Zarr ver2</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shard_shape</span><span class="p">))</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;compressor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;zstd&#39;</span><span class="p">}</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># Zarr ver3</span>
    <span class="c1"># Shard configs{</span>

    <span class="c1"># choose write_chunk_shape and read_chunk_shape that result a chunk byte</span>
    <span class="c1"># size equal or less than the `chunk_byte_size`</span>
    <span class="k">if</span> <span class="n">chunk_byte_size</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">write_chunk_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">read_chunk_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">chunk_byte_size</span> <span class="o">&lt;</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="sa">f</span><span class="s1">&#39;chunk_byte_size=</span><span class="si">{</span><span class="n">chunk_byte_size</span><span class="si">}</span><span class="s1"> must be &gt;= </span><span class="si">{</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="si">}</span><span class="s1">&#39;</span>
          <span class="p">)</span>
        <span class="n">write_chunk_shape</span> <span class="o">=</span> <span class="n">read_chunk_shape</span> <span class="o">=</span> <span class="n">_choose_chunk_shape</span><span class="p">(</span>
            <span class="n">global_shape</span><span class="p">,</span> <span class="n">shard_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">chunk_byte_size</span>
        <span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;`chunk_byte_size` is ignored because `write_chunk_shape` or&#39;</span>
            <span class="s1">&#39; `read_chunk_shape` is not None.&#39;</span>
        <span class="p">)</span>

    <span class="c1"># If `write_chunk_shape` is not specified, make it the same as Jax sharding</span>
    <span class="k">if</span> <span class="n">write_chunk_shape</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_validate_divisible_shapes</span><span class="p">(</span><span class="n">shard_shape</span><span class="p">,</span> <span class="n">write_chunk_shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;write_chunk_shape=</span><span class="si">{</span><span class="n">write_chunk_shape</span><span class="si">}</span><span class="s1"> is not a divisor of&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; shard_shape=</span><span class="si">{</span><span class="n">shard_shape</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
      <span class="n">write_shape</span> <span class="o">=</span> <span class="n">write_chunk_shape</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">write_shape</span> <span class="o">=</span> <span class="n">shard_shape</span>

    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;chunk_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;regular&#39;</span><span class="p">,</span>
        <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;chunk_shape&#39;</span><span class="p">:</span> <span class="n">write_shape</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Sub-chunk configs</span>
    <span class="c1"># If `read_chunk_shape` is not specified, make it the same as</span>
    <span class="c1"># `write_shape`</span>
    <span class="k">if</span> <span class="n">read_chunk_shape</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_validate_divisible_shapes</span><span class="p">(</span><span class="n">write_shape</span><span class="p">,</span> <span class="n">read_chunk_shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;read_chunk_shape=</span><span class="si">{</span><span class="n">read_chunk_shape</span><span class="si">}</span><span class="s1"> is not a divisor of&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; write_chunk_shape=</span><span class="si">{</span><span class="n">write_shape</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
      <span class="n">read_shape</span> <span class="o">=</span> <span class="n">read_chunk_shape</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">read_shape</span> <span class="o">=</span> <span class="n">shard_shape</span>

    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;codecs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;sharding_indexed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;chunk_shape&#39;</span><span class="p">:</span> <span class="n">read_shape</span><span class="p">,</span>
                <span class="s1">&#39;codecs&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;endian&#39;</span><span class="p">:</span> <span class="s1">&#39;little&#39;</span><span class="p">}},</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;zstd&#39;</span><span class="p">},</span>
                <span class="p">],</span>
                <span class="s1">&#39;index_codecs&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;endian&#39;</span><span class="p">:</span> <span class="s1">&#39;little&#39;</span><span class="p">}},</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;crc32c&#39;</span><span class="p">},</span>
                <span class="p">],</span>
                <span class="s1">&#39;index_location&#39;</span><span class="p">:</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">]</span>

  <span class="k">return</span> <span class="n">metadata</span>


<div class="viewcode-block" id="TypeHandler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.TypeHandler">[docs]</a><span class="k">class</span> <span class="nc">TypeHandler</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Interface for reading and writing a PyTree leaf.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TypeHandler.typestr"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.TypeHandler.typestr">[docs]</a>  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">def</span> <span class="nf">typestr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A string representation of the type.</span>

<span class="sd">    Cannot conflict with other types.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The type as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="TypeHandler.metadata"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.TypeHandler.metadata">[docs]</a>  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">async</span> <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Metadata</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructs object metadata from a stored parameter location.</span>

<span class="sd">    Args:</span>
<span class="sd">      infos: sequence of ParamInfo</span>

<span class="sd">    Returns:</span>
<span class="sd">      Sequence of Metadata for each provided ParamInfo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="TypeHandler.serialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.TypeHandler.serialize">[docs]</a>  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">async</span> <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">Future</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes the parameter to a storage location.</span>

<span class="sd">    This method is responsible for copying the parameter from a remote device in</span>
<span class="sd">    a synchronous fashion (if applicable). It should then return a list of</span>
<span class="sd">    futures which can be later awaited to complete the final commit operation</span>
<span class="sd">    to a storage location.</span>

<span class="sd">    The function can be used in a multihost setting, but should not implement</span>
<span class="sd">    extra logic to ensure atomicity.</span>

<span class="sd">    Args:</span>
<span class="sd">      values: a sequence of parameters to save.</span>
<span class="sd">      infos: a sequence of ParamInfo containing relevant information for</span>
<span class="sd">        serialization of each value.</span>
<span class="sd">      args: a sequnece of additional arguments for serialization, provided by</span>
<span class="sd">        the user.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Sequence of commit futures which can be awaited to complete the save</span>
<span class="sd">      operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="TypeHandler.deserialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.TypeHandler.deserialize">[docs]</a>  <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
  <span class="k">async</span> <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RestoreArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads the parameter from a storage location.</span>

<span class="sd">    Args:</span>
<span class="sd">      infos: Sequnece of ParamInfo for deserialization.</span>
<span class="sd">      args: Sequence of user-provided restoration information.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The deserialized parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="TypeHandler.finalize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.TypeHandler.finalize">[docs]</a>  <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs any logic to finalize parameter files written by this class.</span>

<span class="sd">    By default, does nothing.</span>

<span class="sd">    Args:</span>
<span class="sd">      directory: A path to the location of the checkpoint. This corresponds to</span>
<span class="sd">        `param_info.parent_dir`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div></div>


<span class="k">def</span> <span class="nf">check_input_arguments</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="n">l</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot pass TypeHandler input of length 0.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found input args with mismatched lengths.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="is_ocdbt_checkpoint"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.is_ocdbt_checkpoint">[docs]</a><span class="k">def</span> <span class="nf">is_ocdbt_checkpoint</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Determines whether a checkpoint uses OCDBT format.&quot;&quot;&quot;</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="n">_OCDBT_MANIFEST_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></div>


<div class="viewcode-block" id="merge_ocdbt_per_process_files"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.merge_ocdbt_per_process_files">[docs]</a><span class="k">def</span> <span class="nf">merge_ocdbt_per_process_files</span><span class="p">(</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">ts_context</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">Context</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Merges OCDBT files written to per-process subdirectories.</span>

<span class="sd">  With Tensorstore&#39;s OCDBT format, arrays are initially written to per-process</span>
<span class="sd">  subdirectories, depending on which host is doing the writing. This function</span>
<span class="sd">  can be called to merge the per-process files into a global key-value store.</span>

<span class="sd">  The original per-process subdirectories are not and should not be deleted -</span>
<span class="sd">  the global kvstore continues to reference them.</span>

<span class="sd">  Args:</span>
<span class="sd">    directory: checkpoint location.</span>
<span class="sd">    ts_context: Tensorstore context.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">open_ops</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">parent_tspec</span> <span class="o">=</span> <span class="n">_get_tensorstore_spec</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">_add_write_tspec_ocdbt_options</span><span class="p">(</span><span class="n">parent_tspec</span><span class="p">)</span>
  <span class="n">parent_tspec</span> <span class="o">=</span> <span class="n">parent_tspec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">]</span>
  <span class="n">open_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">KvStore</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
          <span class="n">ts</span><span class="o">.</span><span class="n">KvStore</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">parent_tspec</span><span class="p">),</span>
          <span class="n">context</span><span class="o">=</span><span class="n">ts_context</span><span class="p">,</span>
      <span class="p">)</span>
  <span class="p">)</span>

  <span class="k">for</span> <span class="n">process_dir</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_PROCESS_SUBDIR_PREFIX</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">):</span>
    <span class="n">process_id</span> <span class="o">=</span> <span class="n">process_dir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">child_tspec</span> <span class="o">=</span> <span class="n">_get_tensorstore_spec</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">process_id</span><span class="o">=</span><span class="n">process_id</span>
    <span class="p">)</span>
    <span class="n">child_tspec</span> <span class="o">=</span> <span class="n">child_tspec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">]</span>
    <span class="n">open_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">KvStore</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">KvStore</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">child_tspec</span><span class="p">),</span>
            <span class="n">context</span><span class="o">=</span><span class="n">ts_context</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

  <span class="k">async</span> <span class="k">def</span> <span class="nf">open_and_copy</span><span class="p">():</span>
    <span class="n">opened</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">open_ops</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">opened</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opened</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">copy_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txn</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span><span class="n">atomic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
      <span class="n">copy_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
          <span class="n">child</span><span class="o">.</span><span class="n">experimental_copy_range_to</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">))</span>
      <span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">copy_ops</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">txn</span><span class="o">.</span><span class="n">commit_async</span><span class="p">()</span>

  <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">open_and_copy</span><span class="p">())</span></div>


<span class="k">def</span> <span class="nf">_get_kvstore_for_gcs</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="s1">&#39;^gs://([^/]*)/(.*)$&#39;</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s1">&#39;The ckpt_path should contain the bucket name and the &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;file path inside the bucket. Got: </span><span class="si">{</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>
  <span class="n">gcs_bucket</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">path_without_bucket</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;gcs&#39;</span><span class="p">,</span> <span class="s1">&#39;bucket&#39;</span><span class="p">:</span> <span class="n">gcs_bucket</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path_without_bucket</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_get_metadata</span><span class="p">(</span>
    <span class="n">arr</span><span class="p">,</span>
    <span class="n">use_zarr3</span><span class="p">,</span>
    <span class="n">write_chunk_shape</span><span class="p">,</span>
    <span class="n">read_chunk_shape</span><span class="p">,</span>
    <span class="n">chunk_byte_size</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;build metadata for a Tensorstore array.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">:</span>
    <span class="c1"># Tensorstore uses &#39;bfloat16&#39;, not &#39;&lt;V2&#39;.</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;bfloat16&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">str</span>
  <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
      <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">local_shape</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">addressable_data</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
      <span class="n">_build_ts_zarr_shard_and_chunk_metadata</span><span class="p">(</span>
          <span class="n">global_shape</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
          <span class="n">shard_shape</span><span class="o">=</span><span class="n">local_shape</span><span class="p">,</span>
          <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
          <span class="n">use_zarr3</span><span class="o">=</span><span class="n">use_zarr3</span><span class="p">,</span>
          <span class="n">write_chunk_shape</span><span class="o">=</span><span class="n">write_chunk_shape</span><span class="p">,</span>
          <span class="n">read_chunk_shape</span><span class="o">=</span><span class="n">read_chunk_shape</span><span class="p">,</span>
          <span class="n">chunk_byte_size</span><span class="o">=</span><span class="n">chunk_byte_size</span><span class="p">,</span>
      <span class="p">)</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="n">metadata</span>


<span class="k">def</span> <span class="nf">_get_tensorstore_spec</span><span class="p">(</span>
    <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">process_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_zarr3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ocdbt_target_data_file_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Constructs a Tensorstore spec.</span>

<span class="sd">  Args:</span>
<span class="sd">    directory: Parent directory where the parameter will be written.</span>
<span class="sd">    name: Name of the parameter.</span>
<span class="sd">    use_ocdbt: Whether to use OCDBT to write the array.</span>
<span class="sd">    process_id: If provided, will write to a sub-directory named</span>
<span class="sd">      `ocdbt.process_&lt;process_id&gt;`. If a string, must conform to [A-Za-z0-9]+</span>
<span class="sd">      pattern.</span>
<span class="sd">    use_zarr3: If True, use ZARR_VER3 driver, otherwise, use ZARR_VER2 driver.</span>
<span class="sd">    ocdbt_target_data_file_size: Specifies the target size (in bytes) of each</span>
<span class="sd">      OCDBT data file.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A ts.Spec in dictionary form.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">default_driver</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">_DEFAULT_DRIVER</span>  <span class="c1"># pylint: disable=protected-access</span>
  <span class="c1"># Normalize path to exclude trailing &#39;/&#39;. In GCS path case, we will need to</span>
  <span class="c1"># fix the path prefix to add back the stripped &#39;/&#39;.</span>
  <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;gs:/&#39;</span><span class="p">,</span> <span class="s1">&#39;gs://&#39;</span><span class="p">)</span>
  <span class="n">is_gcs_path</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">)</span>
  <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="n">ZARR_VER3</span> <span class="k">if</span> <span class="n">use_zarr3</span> <span class="k">else</span> <span class="n">ZARR_VER2</span><span class="p">,</span> <span class="s1">&#39;kvstore&#39;</span><span class="p">:</span> <span class="p">{}}</span>

  <span class="k">if</span> <span class="n">use_ocdbt</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_gcs_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Checkpoint path should be absolute. Got </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">process_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">process_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">process_id</span><span class="p">)</span>
      <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">_OCDBT_PROCESS_ID_RE</span><span class="p">,</span> <span class="n">process_id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
          <span class="sa">f</span><span class="s1">&#39;process_id must conform to </span><span class="si">{</span><span class="n">_OCDBT_PROCESS_ID_RE</span><span class="si">}</span><span class="s1"> pattern&#39;</span>
          <span class="sa">f</span><span class="s1">&#39;, got </span><span class="si">{</span><span class="n">process_id</span><span class="si">}</span><span class="s1">&#39;</span>
      <span class="p">)</span>
      <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
          <span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_PROCESS_SUBDIR_PREFIX</span><span class="si">}{</span><span class="n">process_id</span><span class="si">}</span><span class="s1">&#39;</span>
      <span class="p">)</span>
    <span class="n">base_driver_spec</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">directory</span>
        <span class="k">if</span> <span class="n">is_gcs_path</span>
        <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="n">default_driver</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">directory</span><span class="p">)}</span>
    <span class="p">)</span>
    <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;ocdbt&#39;</span><span class="p">,</span>
        <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="n">base_driver_spec</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;recheck_cached_data&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;recheck_cached_metadata&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>  <span class="c1"># pytype: disable=attribute-error</span>
        <span class="c1"># Enable read coalescing.  This feature merges adjacent read_ops into</span>
        <span class="c1"># one, which could reduce I/O ops by a factor of 10. This is especially</span>
        <span class="c1"># beneficial for unstacked models.</span>
        <span class="s1">&#39;experimental_read_coalescing_threshold_bytes&#39;</span><span class="p">:</span> <span class="mi">1000000</span><span class="p">,</span>
        <span class="s1">&#39;experimental_read_coalescing_merged_bytes&#39;</span><span class="p">:</span> <span class="mi">500000000000</span><span class="p">,</span>
        <span class="s1">&#39;experimental_read_coalescing_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;1ms&#39;</span><span class="p">,</span>
        <span class="c1"># References the cache specified in ts.Context.</span>
        <span class="s1">&#39;cache_pool&#39;</span><span class="p">:</span> <span class="s1">&#39;cache_pool#ocdbt&#39;</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="n">ocdbt_target_data_file_size</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">][</span><span class="s1">&#39;target_data_file_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ocdbt_target_data_file_size</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_gcs_path</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_kvstore_for_gcs</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="n">default_driver</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">ckpt_path</span><span class="p">}</span>

  <span class="k">return</span> <span class="n">spec</span>


<span class="k">def</span> <span class="nf">get_process_index_for_subdir</span><span class="p">(</span>
    <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;If OCDBT + merge feature is in use, returns a process index.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">use_ocdbt</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">multihost</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_ts_context"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.get_ts_context">[docs]</a><span class="k">def</span> <span class="nf">get_ts_context</span><span class="p">(</span><span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ts</span><span class="o">.</span><span class="n">Context</span><span class="p">:</span>
  <span class="k">del</span> <span class="n">use_ocdbt</span>
  <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">_DEFAULT_OCDBT_TS_CONTEXT</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_cast_tspec_serialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.get_cast_tspec_serialize">[docs]</a><span class="k">def</span> <span class="nf">get_cast_tspec_serialize</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Creates a Tensorstore spec for casting a param during serialize.&quot;&quot;&quot;</span>
  <span class="n">tspec</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="n">tspec</span><span class="p">,</span>
      <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;cast&#39;</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="c1"># Origin dtype.</span>
  <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
  <span class="c1"># Destination dtype.</span>
  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">][</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">][</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
  <span class="k">return</span> <span class="n">tspec</span></div>


<div class="viewcode-block" id="get_cast_tspec_deserialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.get_cast_tspec_deserialize">[docs]</a><span class="k">def</span> <span class="nf">get_cast_tspec_deserialize</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Creates a Tensorstore spec for casting a param during deserialize.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tspec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="n">tspec</span><span class="p">,</span>
        <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;cast&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="n">tspec</span></div>


<span class="k">def</span> <span class="nf">_add_write_tspec_ocdbt_options</span><span class="p">(</span><span class="n">tspec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Adds additional OCDBT options used when writing.&quot;&quot;&quot;</span>
  <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">][</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1"># Store .zarray metadata inline but not large chunks.</span>
      <span class="s1">&#39;max_inline_value_bytes&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
      <span class="c1"># Large value allows a single root node to support faster traversal.</span>
      <span class="s1">&#39;max_decoded_node_bytes&#39;</span><span class="p">:</span> <span class="mi">100000000</span><span class="p">,</span>
      <span class="c1"># There won&#39;t be any concurrent writes by multiple machines to the same</span>
      <span class="c1"># OCDBT database.  Therefore, we can use the simpler and more efficient</span>
      <span class="c1"># single-file manifest format in all cases.</span>
      <span class="s1">&#39;manifest_kind&#39;</span><span class="p">:</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="c1"># assume_config avoids writing an initial empty manifest to ensure a</span>
  <span class="c1"># consistent configuration, since Orbax never writes to the same OCDBT</span>
  <span class="c1"># database concurrently from multiple processes.</span>
  <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">assume_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tspec</span>


<span class="k">def</span> <span class="nf">_array_metadata_from_tensorstore</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
    <span class="n">sharding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sharding_metadata</span><span class="o">.</span><span class="n">ShardingMetadata</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayMetadata</span><span class="p">:</span>
  <span class="k">return</span> <span class="n">ArrayMetadata</span><span class="p">(</span>
      <span class="n">name</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
      <span class="n">directory</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span><span class="p">,</span>
      <span class="n">shape</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
      <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
      <span class="n">sharding</span><span class="o">=</span><span class="n">sharding</span><span class="p">,</span>
  <span class="p">)</span>


<span class="k">def</span> <span class="nf">_dump_debug_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">infos</span><span class="p">):</span>
  <span class="n">ts_metrics</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">experimental_collect_matching_metrics</span><span class="p">(</span><span class="s1">&#39;/tensorstore/&#39;</span><span class="p">)</span>
  <span class="n">ts_metrics</span> <span class="o">+=</span> <span class="p">[</span>
      <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">},</span>
      <span class="p">{</span><span class="s1">&#39;infos&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">]},</span>
  <span class="p">]</span>

  <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">ts_metrics</span><span class="p">)</span>


<div class="viewcode-block" id="NumpyHandler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.NumpyHandler">[docs]</a><span class="k">class</span> <span class="nc">NumpyHandler</span><span class="p">(</span><span class="n">TypeHandler</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Provides an implementation of TypeHandler for replicated numpy arrays.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NumpyHandler.__init__"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.NumpyHandler.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      metadata_key: name to give to Tensorstore metadata files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span> <span class="o">=</span> <span class="n">metadata_key</span></div>

  <span class="k">def</span> <span class="nf">_get_json_tspec_write</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
      <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
      <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
      <span class="n">process_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">arg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec for writing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_json_tspec_write</span><span class="p">(</span>
        <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
        <span class="n">global_shape</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">local_shape</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">,</span>
        <span class="n">process_index</span><span class="o">=</span><span class="n">process_index</span><span class="p">,</span>
        <span class="n">metadata_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span>
        <span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_json_tspec_read</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
      <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec for reading.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_json_tspec_read</span><span class="p">(</span>
        <span class="n">info</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">,</span> <span class="n">metadata_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span>
    <span class="p">)</span>

<div class="viewcode-block" id="NumpyHandler.typestr"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.NumpyHandler.typestr">[docs]</a>  <span class="k">def</span> <span class="nf">typestr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;np.ndarray&#39;</span></div>

<div class="viewcode-block" id="NumpyHandler.metadata"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.NumpyHandler.metadata">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">]</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArrayMetadata</span><span class="p">]:</span>
    <span class="n">open_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
      <span class="c1"># Use OCDBT flag from the existing checkpoint.</span>
      <span class="n">use_ocdbt</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec_read</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">)</span>
      <span class="n">open_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
          <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">tspec</span><span class="p">),</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ts_context</span><span class="p">)</span>
      <span class="p">)</span>

    <span class="n">tensorstores</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">open_ops</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">_array_metadata_from_tensorstore</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">sharding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tensorstores</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
    <span class="p">]</span></div>

<div class="viewcode-block" id="NumpyHandler.serialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.NumpyHandler.serialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">Future</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Uses Tensorstore to serialize a numpy array.&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[</span><span class="n">SaveArgs</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">check_input_arguments</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">copy_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec_write</span><span class="p">(</span>
          <span class="n">info</span><span class="p">,</span>
          <span class="n">value</span><span class="p">,</span>
          <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">,</span>
          <span class="n">process_index</span><span class="o">=</span><span class="n">get_process_index_for_subdir</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">),</span>
          <span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span>
      <span class="p">)</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="n">get_cast_tspec_serialize</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tspec = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tspec</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;infos = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;args = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">multihost</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ts_context</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ts_context</span>
        <span class="c1"># Open once to create metadata and allow the operation to happen</span>
        <span class="c1"># asynchronously.</span>
        <span class="n">open_future</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">tspec</span><span class="p">),</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ts_context</span>
        <span class="p">)</span>
        <span class="c1"># Open again (no disk I/O) to get the write location.</span>
        <span class="n">t</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">tspec</span><span class="p">),</span>
            <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">assume_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">ts_context</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">write_future</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">copy_ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">write_future</span><span class="o">.</span><span class="n">copy</span><span class="p">]</span>
        <span class="n">futures</span> <span class="o">+=</span> <span class="p">[</span><span class="n">open_future</span><span class="p">,</span> <span class="n">write_future</span><span class="o">.</span><span class="n">commit</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">copy_ops</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
          <span class="s1">&#39;ts_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">_dump_debug_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="k">return</span> <span class="n">futures</span></div>

<div class="viewcode-block" id="NumpyHandler.deserialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.NumpyHandler.deserialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RestoreArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deserializes the array using Tensorstore.&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[</span><span class="n">RestoreArgs</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
    <span class="n">check_input_arguments</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">open_futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">info</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">_assert_parameter_files_exist</span><span class="p">(</span>
            <span class="n">info</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">use_zarr3</span>
        <span class="p">)</span>
      <span class="c1"># Use OCDBT flag from the existing checkpoint.</span>
      <span class="n">use_ocdbt</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec_read</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">)</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="n">get_cast_tspec_deserialize</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tspec = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tspec</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;infos = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;args = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
      <span class="n">open_futures</span> <span class="o">+=</span> <span class="p">[</span>
          <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">tspec</span><span class="p">),</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ts_context</span><span class="p">)</span>
      <span class="p">]</span>
    <span class="n">tensorstores</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">open_futures</span><span class="p">)</span>
    <span class="n">read_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensorstores</span><span class="p">]</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">read_ops</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;restored ndarray.shape = </span><span class="si">%s</span><span class="s1">, array.dtype = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
          <span class="s1">&#39;ts_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">_dump_debug_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
      <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div></div>


<div class="viewcode-block" id="ScalarHandler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ScalarHandler">[docs]</a><span class="k">class</span> <span class="nc">ScalarHandler</span><span class="p">(</span><span class="n">NumpyHandler</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A wrapper around NumpyHandler to deal with scalar types (int, float, etc.).&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ScalarHandler.typestr"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ScalarHandler.typestr">[docs]</a>  <span class="k">def</span> <span class="nf">typestr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;scalar&#39;</span></div>

<div class="viewcode-block" id="ScalarHandler.metadata"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ScalarHandler.metadata">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">]</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ScalarMetadata</span><span class="p">]:</span>
    <span class="n">metadatas</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">ScalarMetadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metadatas</span>
    <span class="p">]</span></div>

<div class="viewcode-block" id="ScalarHandler.serialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ScalarHandler.serialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Scalar</span><span class="p">],</span>  <span class="c1"># pytype: disable=signature-mismatch</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">Future</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScalarHandler.deserialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ScalarHandler.deserialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RestoreArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Scalar</span><span class="p">]:</span>  <span class="c1"># pytype: disable=signature-mismatch</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Restored result is not a scalar.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span></div></div>


<span class="k">def</span> <span class="nf">get_sharding_tensorstore_spec</span><span class="p">(</span>
    <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
  <span class="n">kvstore</span> <span class="o">=</span> <span class="n">_get_tensorstore_spec</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">_SHARDING</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
      <span class="s1">&#39;kvstore&#39;</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
      <span class="s1">&#39;kvstore&#39;</span><span class="p">:</span> <span class="n">kvstore</span><span class="p">,</span>
      <span class="s1">&#39;json_pointer&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
          <span class="n">param_name</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
      <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
  <span class="p">}</span>


<div class="viewcode-block" id="ArrayRestoreArgs"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ArrayRestoreArgs">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">ArrayRestoreArgs</span><span class="p">(</span><span class="n">RestoreArgs</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Arguments used when restoring with ArrayHandler.</span>

<span class="sd">  restore_type:</span>
<span class="sd">    See parent class.</span>
<span class="sd">  mesh:</span>
<span class="sd">    The device mesh that the array should be restored as. Cannot be None.</span>
<span class="sd">  mesh_axes:</span>
<span class="sd">    The mesh_axes that the array should be restored as. Cannot be None.</span>
<span class="sd">  sharding:</span>
<span class="sd">   `jax.sharding.Sharding` object which takes precedence over mesh and</span>
<span class="sd">    mesh_axes if provided. Otherwise, mesh and mesh_axes will be used to</span>
<span class="sd">    construct a NamedSharding object OR `ShardingMetadata` which is an orbax</span>
<span class="sd">    representation of `jax.sharding.Sharding` that stores the same properties</span>
<span class="sd">    but does not require accessing real devices.</span>
<span class="sd">  global_shape:</span>
<span class="sd">    The global shape that the array should be restored into. If not</span>
<span class="sd">    provided, the shape will be restored as written. Presently, arbitrary shape</span>
<span class="sd">    transformations are not supported (for example, reshaping to different</span>
<span class="sd">    dimensions). Padding and truncating are supported. When the global_shape is</span>
<span class="sd">    greater than that of the saved array, 0&#39;s will be appended. If the</span>
<span class="sd">    global_shape is shorter than that of the saved array, excess elements will</span>
<span class="sd">    be dropped from the end of the array.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">restore_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
  <span class="n">mesh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">Mesh</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">mesh_axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">PartitionSpec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">sharding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">Sharding</span><span class="p">,</span> <span class="n">ShardingMetadata</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">global_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></div>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">SingleReplicaArrayRestoreArgs</span><span class="p">(</span><span class="n">ArrayRestoreArgs</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Arguments used when restoring with SingleReplicaArrayHandler.</span>

<span class="sd">  In case when training at scale loading checkpoint to all host may be</span>
<span class="sd">  very slow especially when checkpoint file is large. To mitigate this</span>
<span class="sd">  issue `SingleReplicaArrayHandler` suggests to read the checkpoint only</span>
<span class="sd">  on one replica hosts and do broadcasting which should significantly</span>
<span class="sd">  improve the training start time at scale.</span>

<span class="sd">  single_replica_sharding:</span>
<span class="sd">    jax.sharding.NamedSharding object which describes the single replica</span>
<span class="sd">    sharding to which current host belongs to.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">single_replica_sharding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">NamedSharding</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="ArrayHandler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ArrayHandler">[docs]</a><span class="k">class</span> <span class="nc">ArrayHandler</span><span class="p">(</span><span class="n">TypeHandler</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;An implementation of TypeHandler for jax.Array.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ArrayHandler.__init__"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ArrayHandler.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">primary_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">replica_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      metadata_key: name to give to Tensorstore metadata files.</span>
<span class="sd">      primary_host: the host id of the primary host.  Default to 0.  If it&#39;s set</span>
<span class="sd">        to None, then all hosts will be considered as primary.  It&#39;s useful in</span>
<span class="sd">        the case that all hosts are only working with local storage.</span>
<span class="sd">      replica_id: the replica id to be used for saving.  Default to 0.  If it&#39;s</span>
<span class="sd">        set to None, each shards will pick first replica_id to be used.  It&#39;s</span>
<span class="sd">        useful in the case that all hosts are only working with local storage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span> <span class="o">=</span> <span class="n">metadata_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_primary_host</span> <span class="o">=</span> <span class="n">primary_host</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_replica_id</span> <span class="o">=</span> <span class="n">replica_id</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Created `ArrayHandler` with primary_host=</span><span class="si">%s</span><span class="s1">, replica_id=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_host</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replica_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_host</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jax</span><span class="o">.</span><span class="n">__version_info__</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">25</span><span class="p">):</span>  <span class="c1"># pylint:disable=unreachable</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Setting `primary_host` to None requires JAX version &gt; 0.4.25.&#39;</span>
      <span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_get_json_tspec_write</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
      <span class="n">value</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
      <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
      <span class="n">process_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">arg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec for writing.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">get_json_tspec_write</span><span class="p">(</span>
        <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
        <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">,</span>
        <span class="n">global_shape</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">local_shape</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">addressable_data</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">process_index</span><span class="o">=</span><span class="n">process_index</span><span class="p">,</span>
        <span class="n">metadata_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span>
        <span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_json_tspec_read</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
      <span class="n">use_ocdbt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec for reading.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_json_tspec_read</span><span class="p">(</span>
        <span class="n">info</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">,</span> <span class="n">metadata_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span>
    <span class="p">)</span>

<div class="viewcode-block" id="ArrayHandler.typestr"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ArrayHandler.typestr">[docs]</a>  <span class="k">def</span> <span class="nf">typestr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;jax.Array&#39;</span></div>

<div class="viewcode-block" id="ArrayHandler.metadata"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ArrayHandler.metadata">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">]</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArrayMetadata</span><span class="p">]:</span>
    <span class="n">open_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sharding_open_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">shardings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">infos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;parent_dir cannot be None&#39;</span><span class="p">)</span>
    <span class="n">sharding_file_path</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent_dir</span> <span class="o">/</span> <span class="n">_SHARDING</span>
    <span class="n">sharding_file_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">path_utils</span><span class="o">.</span><span class="n">async_exists</span><span class="p">(</span><span class="n">sharding_file_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
      <span class="c1"># Use OCDBT flag from the existing checkpoint.</span>
      <span class="n">use_ocdbt</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec_read</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">)</span>
      <span class="n">open_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
          <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">Spec</span><span class="p">(</span><span class="n">tspec</span><span class="p">),</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ts_context</span><span class="p">)</span>
      <span class="p">)</span>

      <span class="n">sharding_op</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">tspec_sharding</span> <span class="o">=</span> <span class="n">get_sharding_tensorstore_spec</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span><span class="p">),</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sharding_file_exists</span><span class="p">:</span>
          <span class="n">sharding_op</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
              <span class="n">tspec_sharding</span><span class="p">,</span>
              <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="c1"># OCDBT is not used for sharding metadata.</span>
              <span class="n">context</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ts_context</span><span class="p">,</span>
          <span class="p">)</span>
      <span class="n">sharding_open_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharding_op</span><span class="p">)</span>

    <span class="n">tensorstores</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">open_ops</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sharding_file_exists</span><span class="p">:</span>
      <span class="n">sharding_tensorstores</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">sharding_open_ops</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">sharding_tensorstore</span> <span class="ow">in</span> <span class="n">sharding_tensorstores</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sharding_tensorstore</span><span class="p">:</span>
          <span class="n">sharding_string</span> <span class="o">=</span> <span class="k">await</span> <span class="n">sharding_tensorstore</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">sharding_string</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
            <span class="n">shardings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">continue</span>
          <span class="n">deserialized</span> <span class="o">=</span> <span class="n">sharding_metadata</span><span class="o">.</span><span class="n">from_serialized_string</span><span class="p">(</span>
              <span class="n">sharding_string</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
          <span class="p">)</span>
          <span class="n">shardings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deserialized</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">shardings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">shardings</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensorstores</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">_array_metadata_from_tensorstore</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">sharding</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">sharding</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tensorstores</span><span class="p">,</span> <span class="n">infos</span><span class="p">,</span> <span class="n">shardings</span><span class="p">)</span>
    <span class="p">]</span></div>

<div class="viewcode-block" id="ArrayHandler.serialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ArrayHandler.serialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">Future</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span>
          <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span>
          <span class="ow">and</span> <span class="n">jax</span><span class="o">.</span><span class="n">process_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span>
          <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">is_fully_addressable</span>
      <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Cannot serialize host local arrays. Arrays like this are typically&#39;</span>
            <span class="s1">&#39; obtained using pmap. Consider using&#39;</span>
            <span class="s1">&#39; fully_replicated_host_local_array_to_global_array in&#39;</span>
            <span class="s1">&#39; orbax/checkpoint/utils.py to convert your arrays into&#39;</span>
            <span class="s1">&#39; serializable objects.&#39;</span>
        <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[</span><span class="n">SaveArgs</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">check_input_arguments</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">synchronous_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sharding_metadata_txn</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">Transaction</span><span class="p">()</span>
    <span class="n">ocdbt_transaction</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">Transaction</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ocdbt_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">ocdbt_transaction</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">Transaction</span><span class="p">(</span><span class="n">atomic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec_write</span><span class="p">(</span>
          <span class="n">info</span><span class="p">,</span>
          <span class="n">value</span><span class="p">,</span>
          <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">,</span>
          <span class="n">process_index</span><span class="o">=</span><span class="n">get_process_index_for_subdir</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">),</span>
          <span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span>
      <span class="p">)</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="n">get_cast_tspec_serialize</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
      <span class="n">ts_context</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ts_context</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replica_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">replica_id</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">addressable_shards</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replica_id</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">replica_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replica_id</span>
      <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;sharding=</span><span class="si">%s</span><span class="s1">, addressable_shards=</span><span class="si">%s</span><span class="s1">, global_shards=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">.</span><span class="n">sharding</span><span class="p">,</span>
            <span class="n">value</span><span class="o">.</span><span class="n">addressable_shards</span><span class="p">,</span>
            <span class="n">value</span><span class="o">.</span><span class="n">global_shards</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tspec = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tspec</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;infos = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;args = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;replica_id = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">replica_id</span><span class="p">)</span>

      <span class="n">serialize_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">jax</span><span class="o">.</span><span class="n">__version_info__</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">25</span><span class="p">):</span>
        <span class="n">serialize_args</span><span class="p">[</span><span class="s1">&#39;primary_host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_host</span>
        <span class="n">serialize_args</span><span class="p">[</span><span class="s1">&#39;replica_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica_id</span>

      <span class="k">if</span> <span class="n">jax</span><span class="o">.</span><span class="n">__version_info__</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">29</span><span class="p">):</span>
        <span class="n">serialize_args</span><span class="p">[</span><span class="s1">&#39;transaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ocdbt_transaction</span>

      <span class="n">synchronous_ops</span> <span class="o">+=</span> <span class="p">[</span>
          <span class="n">serialization</span><span class="o">.</span><span class="n">async_serialize</span><span class="p">(</span>
              <span class="n">value</span><span class="p">,</span>
              <span class="n">tspec</span><span class="p">,</span>
              <span class="n">commit_future</span><span class="o">=</span><span class="n">futures</span><span class="p">,</span>
              <span class="n">context</span><span class="o">=</span><span class="n">ts_context</span><span class="p">,</span>
              <span class="o">**</span><span class="n">serialize_args</span><span class="p">,</span>
          <span class="p">)</span>
      <span class="p">]</span>

      <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">sharding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;parent_dir cannot be None&#39;</span><span class="p">)</span>
        <span class="n">tspec_sharding</span> <span class="o">=</span> <span class="n">get_sharding_tensorstore_spec</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span><span class="p">),</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">multihost</span><span class="o">.</span><span class="n">is_primary_host</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_host</span><span class="p">):</span>
          <span class="c1"># OCDBT is not used for sharding metadata.</span>
          <span class="n">sharding_ts_context</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ts_context</span>
          <span class="n">t</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
              <span class="n">tspec_sharding</span><span class="p">,</span>
              <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">context</span><span class="o">=</span><span class="n">sharding_ts_context</span><span class="p">,</span>
          <span class="p">)</span>
          <span class="n">serialized_sharding</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="n">sharding_metadata_value</span> <span class="o">=</span> <span class="n">sharding_metadata</span><span class="o">.</span><span class="n">from_jax_sharding</span><span class="p">(</span>
              <span class="n">value</span><span class="o">.</span><span class="n">sharding</span>
          <span class="p">)</span>
          <span class="k">if</span> <span class="n">sharding_metadata_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">serialized_sharding</span> <span class="o">=</span> <span class="n">sharding_metadata_value</span><span class="o">.</span><span class="n">to_serialized_string</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">serialized_sharding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">write_future</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">(</span><span class="n">sharding_metadata_txn</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">serialized_sharding</span>
            <span class="p">)</span>
            <span class="n">synchronous_ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">write_future</span><span class="o">.</span><span class="n">copy</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">synchronous_ops</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
          <span class="s1">&#39;ts_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">_dump_debug_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharding_metadata_txn</span><span class="o">.</span><span class="n">commit_async</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">ocdbt_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocdbt_transaction</span><span class="o">.</span><span class="n">commit_async</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">futures</span></div>

<div class="viewcode-block" id="ArrayHandler.deserialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.ArrayHandler.deserialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RestoreArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.</span>

<span class="sd">    Args:</span>
<span class="sd">      infos: ParamInfo.</span>
<span class="sd">      args: must be of type `ArrayRestoreArgs`.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The deserialized parameter.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError if `args` is not provided.</span>
<span class="sd">      ValueError if `args.sharding` is not provided or `args.mesh` and</span>
<span class="sd">      `args.mesh_axes` are not provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide ArrayRestoreArgs to restore as jax.Array.&#39;</span><span class="p">)</span>
    <span class="n">check_input_arguments</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">deserialize_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">infos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;parent_dir cannot be None&#39;</span><span class="p">)</span>
    <span class="n">sharding_file_path</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent_dir</span> <span class="o">/</span> <span class="n">_SHARDING</span>
    <span class="n">sharding_file_exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">path_utils</span><span class="o">.</span><span class="n">async_exists</span><span class="p">(</span><span class="n">sharding_file_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">info</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
      <span class="n">sharding</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">arg</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ArrayRestoreArgs</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span>
          <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ArrayRestoreArgs</span><span class="p">)</span>
          <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
          <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">mesh_axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
      <span class="p">):</span>
        <span class="n">sharding</span> <span class="o">=</span> <span class="n">NamedSharding</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">mesh_axes</span><span class="p">)</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ArrayRestoreArgs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">sharding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">sharding</span><span class="p">,</span> <span class="n">ShardingMetadata</span><span class="p">):</span>
          <span class="n">sharding</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">to_jax_sharding</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">sharding</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">sharding</span>
      <span class="k">elif</span> <span class="n">sharding_file_exists</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Couldn&#39;t find sharding info under RestoreArgs. Populating sharding&quot;</span>
            <span class="s1">&#39; info from sharding file. Please note restoration time will be&#39;</span>
            <span class="s1">&#39; slightly increased due to reading from file instead of directly&#39;</span>
            <span class="s1">&#39; from RestoreArgs. Note also that this option is unsafe when&#39;</span>
            <span class="s1">&#39; restoring on a different topology than the checkpoint was saved&#39;</span>
            <span class="s1">&#39; with.&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
          <span class="n">tspec_sharding</span> <span class="o">=</span> <span class="n">get_sharding_tensorstore_spec</span><span class="p">(</span>
              <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span><span class="p">),</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>
          <span class="p">)</span>
          <span class="n">t</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
              <span class="n">tspec_sharding</span><span class="p">,</span>
              <span class="c1"># OCDBT is not used for sharding metadata.</span>
              <span class="n">context</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ts_context</span><span class="p">,</span>
              <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
          <span class="p">)</span>
          <span class="n">serialized_string</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">serialized_string</span><span class="p">:</span>
            <span class="n">sharding</span> <span class="o">=</span> <span class="n">sharding_metadata</span><span class="o">.</span><span class="n">get_sharding_or_none</span><span class="p">(</span><span class="n">serialized_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to deserialize sharding.&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Sharding of jax.Array cannot be None. Provide `mesh`&#39;</span>
            <span class="s1">&#39; and `mesh_axes` OR `sharding`&#39;</span>
        <span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">_assert_parameter_files_exist</span><span class="p">(</span>
            <span class="n">info</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span>
            <span class="n">info</span><span class="o">.</span><span class="n">use_zarr3</span><span class="p">,</span>
        <span class="p">)</span>
      <span class="c1"># Use OCDBT flag from the existing checkpoint.</span>
      <span class="n">use_ocdbt</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec_read</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">)</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="n">get_cast_tspec_deserialize</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tspec = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tspec</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;infos = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;args = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
      <span class="n">deserialize_ops</span> <span class="o">+=</span> <span class="p">[</span>
          <span class="n">serialization</span><span class="o">.</span><span class="n">async_deserialize</span><span class="p">(</span>
              <span class="n">sharding</span><span class="p">,</span>
              <span class="n">tspec</span><span class="p">,</span>
              <span class="n">global_shape</span><span class="o">=</span><span class="n">arg</span><span class="o">.</span><span class="n">global_shape</span>
              <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;global_shape&#39;</span><span class="p">)</span>
              <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">byte_limiter</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">byte_limiter</span><span class="p">,</span>
              <span class="n">context</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ts_context</span><span class="p">,</span>
          <span class="p">)</span>
      <span class="p">]</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">deserialize_ops</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">level_debug</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;restored jax.Array.shape = </span><span class="si">%s</span><span class="s1">, jax.array.dtype = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
          <span class="s1">&#39;ts_metrics: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">_dump_debug_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
      <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div></div>


<span class="k">def</span> <span class="nf">_is_sharding_valid</span><span class="p">(</span>
    <span class="n">primary_replica_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">primary_replica_pids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">multihost</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span> <span class="ow">in</span> <span class="n">primary_replica_pids</span><span class="p">:</span>
    <span class="n">loc_devices_in_replica</span> <span class="o">=</span> <span class="n">primary_replica_ids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">jax</span><span class="o">.</span><span class="n">local_devices</span><span class="p">()])</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc_devices_in_replica</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">local_devices</span><span class="p">())</span>
  <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_is_host_for_primary_replica</span><span class="p">(</span><span class="n">primary_replica_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="k">return</span> <span class="n">multihost</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span> <span class="ow">in</span> <span class="n">primary_replica_ids</span>


<span class="k">class</span> <span class="nc">SingleReplicaArrayHandler</span><span class="p">(</span><span class="n">ArrayHandler</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;An implementation TypeHandler for jax.</span>

<span class="sd">  ArrayHandler that optimizes checkpoint read performance during multi-pod or</span>
<span class="sd">  multihost training. Normally each host reads relevant data from the</span>
<span class="sd">  checkpoint, even if other hosts are reading the exact same data. This can be</span>
<span class="sd">  very inefficient with large number of pods/hosts and large checkpoint size.</span>
<span class="sd">  With SingleReplicaArrayhandler the data is read only on hosts that are in</span>
<span class="sd">  primary replica. Then these hosts broadcast the data to other hosts. It is</span>
<span class="sd">  assumed that all hosts have ALL their devices either inside the primary</span>
<span class="sd">  replica or outside.</span>
<span class="sd">  Consider, for example, the following sharding on v4-128 which has 16 hosts and</span>
<span class="sd">  64 devices::</span>

<span class="sd">      shape = (32, 2)</span>
<span class="sd">      mesh = jax.sharding.Mesh(jax.devices().reshape(shape), (&#39;x&#39;, &#39;y&#39;))</span>
<span class="sd">      pspec = jax.sharding.PartitionSpec(None, &#39;y&#39;)</span>
<span class="sd">      sharding=jax.sharding.NamedSharding(mesh, pspec)</span>

<span class="sd">  This sharding will not work since the primary replica has only two devices,</span>
<span class="sd">  and hence there is a host which has 2 devices in the primary replica, and 2</span>
<span class="sd">  devices outside of primary replica. However, changing shape, for example, to</span>
<span class="sd">  (4, 16) will result in a valid sharding.</span>

<span class="sd">  This TypeHandler can be registered by running</span>
<span class="sd">  ```</span>
<span class="sd">  ocp.type_handlers.register_type_handler(</span>
<span class="sd">      jax.Array,</span>
<span class="sd">      type_handlers.SingleReplicaArrayHandler(),</span>
<span class="sd">      override=True)</span>
<span class="sd">  ```</span>
<span class="sd">  Example usage can be found in MaxText (TO BE MERGED).</span>
<span class="sd">  https://github.com/google/maxtext/blob/main/MaxText/checkpointing.py</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">replica_axis_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
               <span class="n">primary_replica_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
               <span class="n">broadcast_memory_limit_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">broadcast_memory_scaling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      replica_axis_index:</span>
<span class="sd">        The index of the axis dimension of the array, along which the replicas</span>
<span class="sd">        are defined.</span>
<span class="sd">        # TODO(b/347273809): Currently works only when replica is taken along</span>
<span class="sd">        # the first dimension, i.e. replica_axis_index is 0.</span>
<span class="sd">      primary_replica_id:</span>
<span class="sd">        The id of the replica hosts that is used to load and broadcast the</span>
<span class="sd">        checkpoint.</span>
<span class="sd">      broadcast_memory_limit_bytes:</span>
<span class="sd">        Specifies the memory size (in bytes) used for broadcasting data.</span>
<span class="sd">      broadcast_memory_scaling_factor:</span>
<span class="sd">        Specifies the fraction of available memory to use for broadcasting data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">SingleReplicaArrayHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">replica_axis_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;replica_axis_index must be 0.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">replica_axis_index</span> <span class="o">=</span> <span class="n">replica_axis_index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">primary_replica_id</span> <span class="o">=</span> <span class="n">primary_replica_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_memory_limit_bytes</span> <span class="o">=</span> <span class="n">broadcast_memory_limit_bytes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_memory_scaling_factor</span> <span class="o">=</span> <span class="n">broadcast_memory_scaling_factor</span>

  <span class="k">async</span> <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SingleReplicaArrayRestoreArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># pytype: disable=signature-mismatch</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deserializing in case of single replica broadcasting.</span>

<span class="sd">    Args:</span>
<span class="sd">      infos: ParamInfo.</span>
<span class="sd">      args: must be of type `SingleReplicaArrayRestoreArgs`.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Deserialized parameters.</span>
<span class="sd">    Raises:</span>
<span class="sd">      ValueError if `args` is not provided.</span>
<span class="sd">      ValueError if `args.sharding` is not provided or `args.mesh` and</span>
<span class="sd">      `args.mesh_axes` or `single_replica_pids` or `single_replica_ids` are</span>
<span class="sd">      not provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Must provide SingleReplicaArrayRestoreArgs to restore as jax.Array.&#39;</span>
      <span class="p">)</span>
    <span class="n">check_input_arguments</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">deserialize_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">shardings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">primary_replica_pids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">single_replica_shardings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">info</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
      <span class="n">arg</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">SingleReplicaArrayRestoreArgs</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SingleReplicaArrayRestoreArgs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Must provide `SingleReplicaArrayRestoreArgs`, but got&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="p">)</span>

      <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">sharding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide `sharding`.&#39;</span><span class="p">)</span>

      <span class="n">sharding</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">sharding</span>
      <span class="n">shardings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharding</span><span class="p">)</span>
      <span class="n">primary_replica_ids</span><span class="p">,</span> <span class="n">primary_replica_pids</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">multihost</span><span class="o">.</span><span class="n">multislice</span><span class="o">.</span><span class="n">get_primary_replica_ids_and_pids</span><span class="p">(</span>
              <span class="n">replica_axis_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">replica_axis_index</span><span class="p">,</span>
              <span class="n">mesh</span><span class="o">=</span><span class="n">sharding</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>  <span class="c1"># pytype: disable=attribute-error</span>
              <span class="n">primary_replica_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_replica_id</span><span class="p">,</span>
          <span class="p">)</span>
      <span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_sharding_valid</span><span class="p">(</span><span class="n">primary_replica_ids</span><span class="p">,</span> <span class="n">primary_replica_pids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;The provided sharding configuration is invalid because it&#39;</span>
            <span class="s1">&#39; includes a host with devices assigned to the primary replica and&#39;</span>
            <span class="s1">&#39; devices outside of the primary replica.&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; primary_replica_ids=</span><span class="si">{</span><span class="n">primary_replica_ids</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;, primary_replica_pids=</span><span class="si">{</span><span class="n">primary_replica_pids</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

      <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">single_replica_sharding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide `single_replica_sharding`.&#39;</span><span class="p">)</span>
      <span class="n">single_replica_sharding</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">single_replica_sharding</span>
      <span class="n">single_replica_shardings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_replica_sharding</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">_assert_parameter_files_exist</span><span class="p">(</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="n">info</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_key</span>
        <span class="p">)</span>

      <span class="n">use_ocdbt</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">is_ocdbt_checkpoint</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec_read</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="n">use_ocdbt</span><span class="p">)</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="n">get_cast_tspec_deserialize</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>

      <span class="k">if</span> <span class="n">_is_host_for_primary_replica</span><span class="p">(</span><span class="n">primary_replica_pids</span><span class="p">):</span>
        <span class="n">deserialize_ops</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">serialization</span><span class="o">.</span><span class="n">async_deserialize</span><span class="p">(</span>
                <span class="n">single_replica_sharding</span><span class="p">,</span>
                <span class="n">tspec</span><span class="p">,</span>
                <span class="n">global_shape</span><span class="o">=</span><span class="n">arg</span><span class="o">.</span><span class="n">global_shape</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;global_shape&#39;</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">byte_limiter</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">byte_limiter</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">ts_context</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_shardings</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">single_replica_shardings</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_zeros</span><span class="p">(</span><span class="n">shape_dtype_tup</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
          <span class="k">lambda</span> <span class="n">sd</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sd</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">shape_dtype_tup</span>
      <span class="p">)</span>

    <span class="k">if</span> <span class="n">_is_host_for_primary_replica</span><span class="p">(</span><span class="n">primary_replica_pids</span><span class="p">):</span>
      <span class="n">start_deserialization</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
      <span class="n">deserialized</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">deserialize_ops</span><span class="p">)</span>
      <span class="n">deserialization_elapsed_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_deserialization</span>
      <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
          <span class="s1">&#39;/jax/checkpoint/read/primary_replica_deserialization_duration_secs&#39;</span><span class="p">,</span>
          <span class="n">deserialization_elapsed_s</span><span class="p">,</span>
      <span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s1">&#39;Finished primary replica deserialization in </span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span>
          <span class="n">deserialization_elapsed_s</span><span class="p">,</span>
      <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">single_replica_shardings</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">single_replica_sharding</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
      <span class="n">shape_dtype</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">global_shape</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span>
      <span class="p">]</span>
      <span class="n">deserialized</span> <span class="o">=</span> <span class="n">create_zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">shape_dtype</span><span class="p">))</span>

    <span class="n">deserialized</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">deserialized</span><span class="p">)</span>
    <span class="n">single_replica_shardings</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">single_replica_shardings</span><span class="p">)</span>

    <span class="n">start_broadcast</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">global_mesh</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">NamedSharding</span><span class="p">,</span> <span class="n">shardings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">shared_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multihost</span><span class="o">.</span><span class="n">multislice</span><span class="o">.</span><span class="n">broadcast_one_replica_to_all</span><span class="p">(</span>
        <span class="n">deserialized</span><span class="p">,</span>
        <span class="n">global_mesh</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
        <span class="n">single_replica_shardings</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replica_axis_index</span><span class="p">,</span>
        <span class="n">_is_host_for_primary_replica</span><span class="p">(</span><span class="n">primary_replica_pids</span><span class="p">),</span>
        <span class="n">memory_limit_bytes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast_memory_limit_bytes</span><span class="p">,</span>
        <span class="n">memory_scaling_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast_memory_scaling_factor</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">broadcast_elapsed_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_broadcast</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">record_event_duration_secs</span><span class="p">(</span>
        <span class="s1">&#39;/jax/checkpoint/read/broadcast_duration_secs&#39;</span><span class="p">,</span> <span class="n">broadcast_elapsed_s</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished broadcasting in </span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">broadcast_elapsed_s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shared_state</span>


<div class="viewcode-block" id="StringHandler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.StringHandler">[docs]</a><span class="k">class</span> <span class="nc">StringHandler</span><span class="p">(</span><span class="n">TypeHandler</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;TypeHandler for strings.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="StringHandler.__init__"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.StringHandler.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s1">&#39;_strings.json&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ts_context</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">TS_CONTEXT</span></div>

  <span class="k">def</span> <span class="nf">_get_json_tspec</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">info</span><span class="p">:</span> <span class="n">ParamInfo</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets Tensorstore spec in JSON format.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must construct serialization path.&#39;</span><span class="p">)</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
    <span class="n">tspec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_tensorstore_spec</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">use_ocdbt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tspec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;kvstore&#39;</span><span class="p">:</span> <span class="n">tspec</span><span class="p">[</span><span class="s1">&#39;kvstore&#39;</span><span class="p">],</span>
        <span class="s1">&#39;json_pointer&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">tspec</span>

<div class="viewcode-block" id="StringHandler.typestr"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.StringHandler.typestr">[docs]</a>  <span class="k">def</span> <span class="nf">typestr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;string&#39;</span></div>

<div class="viewcode-block" id="StringHandler.metadata"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.StringHandler.metadata">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">]</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StringMetadata</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">StringMetadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">parent_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span>
    <span class="p">]</span></div>

  <span class="k">async</span> <span class="k">def</span> <span class="nf">_convert_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensorstore</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tensorstore</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<div class="viewcode-block" id="StringHandler.serialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.StringHandler.serialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SaveArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">Future</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">del</span> <span class="n">args</span>
    <span class="n">check_input_arguments</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">infos</span><span class="p">)</span>
    <span class="n">synchronous_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">txn</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">Transaction</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span>
        <span class="n">info</span><span class="p">,</span>
        <span class="n">value</span><span class="p">,</span>
    <span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">multihost</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">tspec</span><span class="p">,</span>
            <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts_context</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">write_future</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">synchronous_ops</span> <span class="o">+=</span> <span class="p">[</span><span class="n">write_future</span><span class="o">.</span><span class="n">copy</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">synchronous_ops</span><span class="p">)</span>
    <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txn</span><span class="o">.</span><span class="n">commit_async</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">futures</span></div>

<div class="viewcode-block" id="StringHandler.deserialize"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.StringHandler.deserialize">[docs]</a>  <span class="k">async</span> <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">infos</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParamInfo</span><span class="p">],</span>
      <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RestoreArgs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;See superclass documentation.&quot;&quot;&quot;</span>
    <span class="k">del</span> <span class="n">args</span>
    <span class="n">check_input_arguments</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">infos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">open_futures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
      <span class="n">info</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">epath</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">directory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
      <span class="n">tspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_json_tspec</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
      <span class="n">open_future</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
          <span class="n">tspec</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts_context</span>
      <span class="p">)</span>
      <span class="n">open_futures</span> <span class="o">+=</span> <span class="p">[</span><span class="n">open_future</span><span class="p">]</span>
    <span class="n">tensorstores</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">open_futures</span><span class="p">)</span>
    <span class="n">read_ops</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_string</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensorstores</span><span class="p">]</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">read_ops</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TypeHandlerRegistry"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.TypeHandlerRegistry">[docs]</a><span class="k">class</span> <span class="nc">TypeHandlerRegistry</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A registry for TypeHandlers.</span>

<span class="sd">  This internal base class is used for the global registry which serves as a</span>
<span class="sd">  default for any type not found in a local registry. It is also accessed</span>
<span class="sd">  through the module function get/set/has_type_handler.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
      <span class="n">handler</span><span class="p">:</span> <span class="n">TypeHandler</span><span class="p">,</span>
      <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registers a type for serialization/deserialization with a given handler.</span>

<span class="sd">    Note that it is possible for a type to match multiple different entries in</span>
<span class="sd">    the registry, each with a different handler. In this case, only the first</span>
<span class="sd">    match is used.</span>

<span class="sd">    Args:</span>
<span class="sd">      ty: A type to register.</span>
<span class="sd">      handler: a TypeHandler capable of reading and writing parameters of type</span>
<span class="sd">        `ty`.</span>
<span class="sd">      func: A function that accepts a type and returns True if the type should</span>
<span class="sd">        be handled by the provided TypeHandler. If this parameter is not</span>
<span class="sd">        specified, defaults to `lambda t: issubclass(t, ty)`.</span>
<span class="sd">      override: if True, will override an existing mapping of type to handler.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError if a type is already registered and override is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the handler registered for a given type, if available.</span>

<span class="sd">    Args:</span>
<span class="sd">      ty: an object type (or string representation of the type.)</span>

<span class="sd">    Returns:</span>
<span class="sd">      The TypeHandler that is registered for the given type.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError if the given type has no registered handler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>

  <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if a type is registered.</span>

<span class="sd">    Args:</span>
<span class="sd">      ty: an object type (or string representation of the type.)</span>

<span class="sd">    Returns:</span>
<span class="sd">      A boolean indicating if ty is registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span></div>


<span class="k">class</span> <span class="nc">_TypeHandlerRegistryImpl</span><span class="p">(</span><span class="n">TypeHandlerRegistry</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;The implementation for TypeHandlerRegistry.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">handlers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">TypeHandler</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a type registry.</span>

<span class="sd">    Args:</span>
<span class="sd">      *handlers: an optional list of handlers to initialize with.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_type_registry</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">TypeHandler</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_typestr_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TypeHandler</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">handlers</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">ty</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
      <span class="n">handler</span><span class="p">:</span> <span class="n">TypeHandler</span><span class="p">,</span>
      <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
      <span class="n">ignore_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
  <span class="p">):</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span>

    <span class="n">existing_handler_idx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_registry</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">ty</span><span class="p">):</span>
        <span class="n">existing_handler_idx</span> <span class="o">=</span> <span class="n">i</span>
        <span class="c1"># Ignore the possibility for subsequent matches, as these will not be</span>
        <span class="c1"># used anyway.</span>
        <span class="k">break</span>

    <span class="k">if</span> <span class="n">existing_handler_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">typestr</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typestr_registry</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_warnings</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Type handler registry overriding type &quot;</span><span class="si">%s</span><span class="s1">&quot; collision on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">ty</span><span class="p">,</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">typestr</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="sa">f</span><span class="s1">&#39;Type &quot;</span><span class="si">{</span><span class="n">ty</span><span class="si">}</span><span class="s1">&quot; has a `typestr` (&quot;</span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">typestr</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot;) which&#39;</span>
              <span class="s1">&#39; collides with that of an existing TypeHandler.&#39;</span>
          <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_type_registry</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_typestr_registry</span><span class="p">[</span><span class="n">handler</span><span class="o">.</span><span class="n">typestr</span><span class="p">()]</span> <span class="o">=</span> <span class="n">handler</span>
    <span class="k">elif</span> <span class="n">override</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_warnings</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Type handler registry type &quot;</span><span class="si">%s</span><span class="s1">&quot; overriding </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">ty</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">typestr</span><span class="p">(),</span>
        <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_type_registry</span><span class="p">[</span><span class="n">existing_handler_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_typestr_registry</span><span class="p">[</span><span class="n">handler</span><span class="o">.</span><span class="n">typestr</span><span class="p">()]</span> <span class="o">=</span> <span class="n">handler</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A TypeHandler for &quot;</span><span class="si">{</span><span class="n">ty</span><span class="si">}</span><span class="s1">&quot; is already registered.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeHandler</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">ty</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typestr_registry</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typestr_registry</span><span class="p">[</span><span class="n">ty</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_registry</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="n">ty</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">handler</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown type: &quot;</span><span class="si">{</span><span class="n">ty</span><span class="si">}</span><span class="s1">&quot;. Must register a TypeHandler.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ty</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>


<span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span> <span class="o">=</span> <span class="n">_TypeHandlerRegistryImpl</span><span class="p">(</span>
    <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">()),</span>
    <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">()),</span>
    <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">()),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">()),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">NumpyHandler</span><span class="p">()),</span>
    <span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">ArrayHandler</span><span class="p">()),</span>
    <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">StringHandler</span><span class="p">()),</span>
<span class="p">)</span>


<div class="viewcode-block" id="create_type_handler_registry"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.create_type_handler_registry">[docs]</a><span class="k">def</span> <span class="nf">create_type_handler_registry</span><span class="p">(</span>
    <span class="o">*</span><span class="n">handlers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">TypeHandler</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeHandlerRegistry</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Create a type registry.</span>

<span class="sd">  Args:</span>
<span class="sd">    *handlers: optional pairs of `(&lt;type&gt;, &lt;handler&gt;)` to initialize the</span>
<span class="sd">      registry with.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A TypeHandlerRegistry instance with only the specified handlers.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">_TypeHandlerRegistryImpl</span><span class="p">(</span><span class="o">*</span><span class="n">handlers</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_type_handler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.register_type_handler">[docs]</a><span class="k">def</span> <span class="nf">register_type_handler</span><span class="p">(</span>
    <span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">handler</span><span class="p">:</span> <span class="n">TypeHandler</span><span class="p">,</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Registers a type for serialization/deserialization with a given handler.</span>

<span class="sd">  Note that it is possible for a type to match multiple different entries in</span>
<span class="sd">  the registry, each with a different handler. In this case, only the first</span>
<span class="sd">  match is used.</span>

<span class="sd">  Args:</span>
<span class="sd">    ty: A type to register.</span>
<span class="sd">    handler: a TypeHandler capable of reading and writing parameters of type</span>
<span class="sd">      `ty`.</span>
<span class="sd">    func: A function that accepts a type and returns True if the type should be</span>
<span class="sd">      handled by the provided TypeHandler. If this parameter is not specified,</span>
<span class="sd">      defaults to `lambda t: issubclass(t, ty)`.</span>
<span class="sd">    override: if True, will override an existing mapping of type to handler.</span>

<span class="sd">  Raises:</span>
<span class="sd">    ValueError if a type is already registered and override is False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">override</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_type_handler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.get_type_handler">[docs]</a><span class="k">def</span> <span class="nf">get_type_handler</span><span class="p">(</span><span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeHandler</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the handler registered for a given type, if available.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ty</span><span class="p">)</span></div>


<div class="viewcode-block" id="has_type_handler"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.has_type_handler">[docs]</a><span class="k">def</span> <span class="nf">has_type_handler</span><span class="p">(</span><span class="n">ty</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns if there is a handler registered for a given type.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">ty</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_standard_handlers_with_options"><a class="viewcode-back" href="../../../api_reference/checkpoint.type_handlers.html#orbax.checkpoint.type_handlers.register_standard_handlers_with_options">[docs]</a><span class="k">def</span> <span class="nf">register_standard_handlers_with_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Re-registers a select set of handlers with the given options.</span>

<span class="sd">  This is intended to override options en masse for the standard numeric</span>
<span class="sd">  TypeHandlers and their corresponding types (scalars, numpy arrays and</span>
<span class="sd">  jax.Arrays).</span>

<span class="sd">  Args:</span>
<span class="sd">    **kwargs: keyword arguments to pass to each of the standard handlers.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># TODO(b/314258967): clean those up.</span>
  <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;use_ocdbt&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ts_context&#39;</span><span class="p">]</span>
  <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
      <span class="nb">float</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>
  <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
      <span class="nb">bytes</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>
  <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
      <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">ScalarHandler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>
  <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
      <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">NumpyHandler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span>
  <span class="n">GLOBAL_TYPE_HANDLER_REGISTRY</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
      <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">ArrayHandler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span>
  <span class="p">)</span></div>


<span class="c1"># TODO(b/253238305) Deprecate when all checkpoints have saved types.</span>
<span class="k">def</span> <span class="nf">default_restore_type</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">RestoreArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">ArrayRestoreArgs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">RestoreArgs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported restore_args type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_param_typestr</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">TypeHandlerRegistry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Retrieves the typestr for a given value.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">is_supported_empty_aggregation_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">typestr</span> <span class="o">=</span> <span class="n">get_empty_value_typestr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">handler</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="n">typestr</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">typestr</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="c1"># Not an error because users&#39; training states often have a bunch of</span>
      <span class="c1"># random unserializable objects in them (empty states, optimizer</span>
      <span class="c1"># objects, etc.). An error occurring due to a missing TypeHandler</span>
      <span class="c1"># will be surfaced elsewhere.</span>
      <span class="n">typestr</span> <span class="o">=</span> <span class="n">RESTORE_TYPE_NONE</span>
  <span class="k">return</span> <span class="n">typestr</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Orbax Contributors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024, Google.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrape6c2.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-themee6c2.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>

<!-- Mirrored from orbax.readthedocs.io/en/latest/_modules/orbax/checkpoint/type_handlers.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Jul 2024 12:12:01 GMT -->
</html>